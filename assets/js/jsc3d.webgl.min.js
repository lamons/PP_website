var JSC3D=JSC3D||{};JSC3D.WebGLRenderBackend=function(e,r){function i(e,r,i){var t=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(t,r),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured in shader compilation: "+e.getShaderInfoLog(t)+" The corresponding program will be ignored."),null;var a=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(a,i),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured in shader compilation: "+e.getShaderInfoLog(a)+" The corresponding program will be ignored."),null;var o=e.createProgram();if(e.attachShader(o,t),e.attachShader(o,a),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))return JSC3D.console&&JSC3D.console.logWarning("Error occured when generating program: "+e.getProgramInfoLog(o)+" This program will be ignored."),null;o.attributes={};for(var n=e.getProgramParameter(o,e.ACTIVE_ATTRIBUTES),s=0;n>s;s++){var u=e.getActiveAttrib(o,s);o.attributes[u.name]=e.getAttribLocation(o,u.name)}o.uniforms={};for(var f=e.getProgramParameter(o,e.ACTIVE_UNIFORMS),s=0;f>s;s++){var l=e.getActiveUniform(o,s);o.uniforms[l.name]=e.getUniformLocation(o,l.name)}return o}if(this.canvas=e,this.isIE11="ie"==JSC3D.PlatformInfo.browser&&parseInt(JSC3D.PlatformInfo.version)>=11,this.gl=e.getContext("experimental-webgl",{preserveDrawingBuffer:!0})||e.getContext("webgl"),!this.gl)throw"JSC3D.WebGLRenderBackend constructor failed: Cannot get WebGL context!";this.definition="standard",this.bkgColors=[0,0],this.bkgTexture=null,this.backFB=null,this.pickingFB=null,this.pickingResult=new Uint8Array(4),this.releaseLocalBuffers=r||!1,this.screen_vs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nattribute vec2 a_position; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n	v_texCoord = vec2(0.5, 0.5) * a_position + vec2(0.5, 0.5); \n	gl_Position = vec4(a_position, 1.0, 1.0); \n}",this.screen_fs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform sampler2D s_screenTexture; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n	gl_FragColor = texture2D(s_screenTexture, v_texCoord); \n}",this.gradient_background_vs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform vec3 u_color1; \nuniform vec3 u_color2; \nattribute vec2 a_position; \nvarying vec4 v_color; \n\nvoid main(void) { \n	v_color = vec4(a_position.y > 0.0 ? u_color1 : u_color2, 1.0); \n	gl_Position = vec4(a_position, 1.0, 1.0); \n}",this.gradient_background_fs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nvarying vec4 v_color; \n\nvoid main(void) { \n	gl_FragColor = v_color;}",this.frame_vs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform bool u_isPoint; \nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \n\nvoid main(void) { \n	if(u_isPoint) { \n		gl_PointSize = 2.0; \n	} \n	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n}",this.frame_fs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform vec3 u_materialColor; \n\nvoid main(void) { \n	gl_FragColor = vec4(u_materialColor, 1.0); \n}",this.solid_vs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform bool u_isLit; \nuniform bool u_isCast; \nuniform bool u_hasTexture; \nuniform mat3 u_rotationMatrix; \nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \nattribute vec3 a_normal; \nattribute vec2 a_texCoord; \nvarying vec3 v_normal; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n	if(u_isLit) { \n		v_normal = u_rotationMatrix * a_normal; \n	} \n	if(u_hasTexture) { \n		v_texCoord = a_texCoord; \n	} \n	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n}",this.solid_fs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform bool  u_isLit; \nuniform bool  u_isCast; \nuniform bool  u_hasTexture; \nuniform float u_opacity; \nuniform sampler2D s_palette; \nuniform sampler2D s_texture; \nuniform sampler2D s_sphereTexture; \nvarying vec3 v_normal; \nvarying vec2 v_texCoord; \n\nvoid main(void) { \n	vec4 materialColor = u_isLit ? vec4(texture2D(s_palette, vec2(abs(v_normal.z), 0.0)).rgb, u_opacity) : vec4(1.0, 1.0, 1.0, u_opacity); \n	if(u_isCast) { \n		gl_FragColor = materialColor * texture2D(s_sphereTexture, vec2(0.5, -0.5) * v_normal.xy + vec2(0.5, 0.5)); \n	} \n	else { \n		gl_FragColor = u_hasTexture ? (materialColor * texture2D(s_texture, v_texCoord)) : materialColor; \n	} \n}",this.picking_vs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform mat4 u_transformMatrix; \nattribute vec3 a_position; \n\nvoid main(void) { \n	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n}",this.picking_fs="#ifdef GL_ES \n	precision mediump float; \n#endif	\n\nuniform vec3 u_pickingId; \n\nvoid main(void) { \n	gl_FragColor = vec4(u_pickingId, 1.0); \n}",this.programs={screen:i(this.gl,this.screen_vs,this.screen_fs),gradient_background:i(this.gl,this.gradient_background_vs,this.gradient_background_fs),frame:i(this.gl,this.frame_vs,this.frame_fs),solid:i(this.gl,this.solid_vs,this.solid_fs),picking:i(this.gl,this.picking_vs,this.picking_fs)},this.canvasBoard=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.canvasBoard),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,1,1,-1,1,-1,-1]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)},JSC3D.WebGLRenderBackend.prototype.setBackgroundColors=function(e,r){this.bkgColors=[new Float32Array([(16711680&e)/16777216,(65280&e)/65536,(255&e)/256])],e!=r&&this.bkgColors.push(new Float32Array([(16711680&r)/16777216,(65280&r)/65536,(255&r)/256]))},JSC3D.WebGLRenderBackend.prototype.setBackgroundImage=function(e){var r=this.gl;this.bkgTexture=r.createTexture(),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.bindTexture(r.TEXTURE_2D,this.bkgTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1)},JSC3D.WebGLRenderBackend.prototype.beginFrame=function(e,r){function i(e,r,i,t){e.bindFramebuffer(e.FRAMEBUFFER,r);var a=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,a),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i,t),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,a),e.bindRenderbuffer(e.RENDERBUFFER,null);var o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,t,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),r.width=i,r.height=t,r.texture=o,r.depthRB=a}function t(e,r){e.deleteRenderbuffer(r.depthRB),e.deleteTexture(r.texture),e.deleteFramebuffer(r)}var a=this.gl;this.pickingFB||(this.pickingFB=a.createFramebuffer(),i(a,this.pickingFB,this.canvas.width,this.canvas.height),a.bindFramebuffer(a.FRAMEBUFFER,null));var o=this.canvas.width,n=this.canvas.height;switch(e){case"low":o>>=1,n>>=1;break;case"high":o*=2,n*=2;break;case"standard":}if(o!=this.canvas.width?this.backFB?this.definition!=e?i(a,this.backFB,o,n):a.bindFramebuffer(a.FRAMEBUFFER,this.backFB):(this.backFB=a.createFramebuffer(),i(a,this.backFB,o,n)):this.backFB&&(t(a,this.backFB),this.backFB=null),this.definition=e,a.viewport(0,0,o,n),r)if(this.bkgTexture)a.frontFace(a.CCW),a.disable(a.DEPTH_TEST),a.clear(a.DEPTH_BUFFER_BIT),a.useProgram(this.programs.screen),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.bkgTexture),a.uniform1i(this.programs.screen.uniforms.s_screenTexture,0),a.enableVertexAttribArray(0),a.bindBuffer(a.ARRAY_BUFFER,this.canvasBoard),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindTexture(a.TEXTURE_2D,null);else if(this.bkgColors.length>1)a.frontFace(a.CCW),a.disable(a.DEPTH_TEST),a.clear(a.DEPTH_BUFFER_BIT),a.useProgram(this.programs.gradient_background),a.uniform3fv(this.programs.gradient_background.uniforms.u_color1,this.bkgColors[0]),a.uniform3fv(this.programs.gradient_background.uniforms.u_color2,this.bkgColors[1]),a.enableVertexAttribArray(0),a.bindBuffer(a.ARRAY_BUFFER,this.canvasBoard),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,6),a.bindBuffer(a.ARRAY_BUFFER,null);else{var s=this.bkgColors[0];a.clearColor(s[0],s[1],s[2],1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)}else a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},JSC3D.WebGLRenderBackend.prototype.endFrame=function(){var e=this.gl;switch(e.bindFramebuffer(e.FRAMEBUFFER,null),this.definition){case"low":case"high":this.backFB&&(e.viewport(0,0,this.canvas.width,this.canvas.height),e.frontFace(e.CCW),e.disable(e.DEPTH_TEST),e.useProgram(this.programs.screen),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.backFB.texture),e.uniform1i(this.programs.screen.uniforms.s_screenTexture,0),e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,this.canvasBoard),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindTexture(e.TEXTURE_2D,null));break;case"standard":}e.flush()},JSC3D.WebGLRenderBackend.prototype.render=function(e,r,i,t,a,o,n){function s(e){for(var i=[],t=[],o=0;o<e.length;o++){var n=e[o];(n.material||a).transparency>0||n.hasTexture()&&n.texture.hasTransparency?(n.c?n.aabb.center(n.c):n.c=n.aabb.center(),JSC3D.Math3D.transformVectors(r,n.c,n.c),t.push(n)):i.push(n)}return t.sort(function(e,r){return e.c[2]-r.c[2]}),t.length>0?i.concat(t):i}var u=this.gl,f=new Float32Array([r.m00,r.m10,r.m20,0,r.m01,r.m11,r.m21,0,r.m02,r.m12,r.m22,0,r.m03,r.m13,r.m23,1]),l=new Float32Array([i.m00,i.m10,i.m20,i.m01,i.m11,i.m21,i.m02,i.m12,i.m22]);e=s(e),this.renderColorPass(e,f,l,t,a,o,n),this.pickingFB&&(u.bindFramebuffer(u.FRAMEBUFFER,this.pickingFB),this.renderPickingPass(e,f,a,n),u.bindFramebuffer(u.FRAMEBUFFER,null))},JSC3D.WebGLRenderBackend.prototype.pick=function(e,r){if(!this.pickingFB)return 0;var i=this.gl;return i.bindFramebuffer(i.FRAMEBUFFER,this.pickingFB),i.readPixels(e,this.pickingFB.height-r,1,1,i.RGBA,i.UNSIGNED_BYTE,this.pickingResult),i.bindFramebuffer(i.FRAMEBUFFER,null),this.pickingResult[0]<<16|this.pickingResult[1]<<8|this.pickingResult[2]},JSC3D.WebGLRenderBackend.prototype.renderColorPass=function(e,r,i,t,a,o,n){o&&o.hasData()&&!o.compiled&&this.compileTexture(o);var s=this.gl;s.disable(s.BLEND),s.enable(s.DEPTH_TEST),s.depthMask(!0),s.frontFace(s.CCW);for(var u=null,f=!1,l=0;l<e.length;l++){var d=e[l];if(!d.isTrivial()&&d.visible){var m=d.material||a,c=d.hasTexture()?d.texture:null,_=m.transparency>0||c&&c.hasTransparency,E=1-m.transparency;m.compiled||this.compileMaterial(m),c&&!c.compiled&&this.compileTexture(c),n||d.isDoubleSided?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),_!=f&&(_?(s.depthMask(!1),s.enable(s.BLEND),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE)):(s.depthMask(!0),s.disable(s.BLEND)),f=_);var T,R=d.isEnvironmentCast&&null!=o,b=d.renderMode||t;switch(b){case"point":case"wireframe":T=this.programs.frame;break;case"flat":case"smooth":T=this.programs.solid;break;case"texture":case"textureflat":c||(b="flat"),T=this.programs.solid;break;case"texturesmooth":c||R||(b="smooth"),T=this.programs.solid;break;default:b="flat",T=this.programs.solid}switch(d.compiled&&d.compiled.remderMode==b||this.compileMesh(d,b),u!=T&&(s.useProgram(T),u=T),b){case"point":s.uniform1i(T.uniforms.u_isPoint,!0),s.uniform3fv(T.uniforms.u_materialColor,m.compiled.diffColor),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.coords),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.drawArrays(s.POINTS,0,d.compiled.coordCount);break;case"wireframe":s.uniform1i(T.uniforms.u_isPoint,!1),s.uniform3fv(T.uniforms.u_materialColor,m.compiled.diffColor),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.edges),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.drawArrays(s.LINES,0,d.compiled.edgeCount);break;case"flat":case"smooth":s.uniform1i(T.uniforms.u_isLit,!0),s.uniform1i(T.uniforms.u_isCast,!1),s.uniform1i(T.uniforms.u_hasTexture,!1),s.uniform1f(T.uniforms.u_opacity,E),s.uniformMatrix3fv(T.uniforms.u_rotationMatrix,!1,i),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,m.compiled.palette),s.uniform1i(T.uniforms.s_palette,0),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.coords),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(T.attributes.a_normal),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.normals),s.vertexAttribPointer(T.attributes.a_normal,3,s.FLOAT,!1,0,0),s.disableVertexAttribArray(T.attributes.a_texCoord),s.drawArrays(s.TRIANGLES,0,d.compiled.coordCount);break;case"texture":s.uniform1i(T.uniforms.u_isLit,!1),s.uniform1i(T.uniforms.u_isCast,!1),s.uniform1i(T.uniforms.u_hasTexture,!0),s.uniform1f(T.uniforms.u_opacity,E),s.uniformMatrix3fv(T.uniforms.u_rotationMatrix,!1,i),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,c.compiled.tex),s.uniform1i(T.uniforms.s_texture,1),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.coords),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.disableVertexAttribArray(T.attributes.a_normal),s.enableVertexAttribArray(T.attributes.a_texCoord),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.texcoords),s.vertexAttribPointer(T.attributes.a_texCoord,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,d.compiled.coordCount);break;case"textureflat":s.uniform1i(T.uniforms.u_isLit,!0),s.uniform1i(T.uniforms.u_isCast,!1),s.uniform1i(T.uniforms.u_hasTexture,!0),s.uniform1f(T.uniforms.u_opacity,E),s.uniformMatrix3fv(T.uniforms.u_rotationMatrix,!1,i),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,m.compiled.palette),s.uniform1i(T.uniforms.s_palette,0),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,c.compiled.tex),s.uniform1i(T.uniforms.s_texture,1),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.coords),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(T.attributes.a_normal),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.normals),s.vertexAttribPointer(T.attributes.a_normal,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(T.attributes.a_texCoord),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.texcoords),s.vertexAttribPointer(T.attributes.a_texCoord,2,s.FLOAT,!1,0,0),s.drawArrays(s.TRIANGLES,0,d.compiled.coordCount);break;case"texturesmooth":s.uniform1i(T.uniforms.u_isLit,!0),s.uniform1i(T.uniforms.u_isCast,R),s.uniform1i(T.uniforms.u_hasTexture,!R),s.uniform1f(T.uniforms.u_opacity,E),s.uniformMatrix3fv(T.uniforms.u_rotationMatrix,!1,i),s.uniformMatrix4fv(T.uniforms.u_transformMatrix,!1,r),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,m.compiled.palette),s.uniform1i(T.uniforms.s_palette,0),R?(s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,o.compiled.tex),s.uniform1i(T.uniforms.s_sphereTexture,2)):(s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,c.compiled.tex),s.uniform1i(T.uniforms.s_texture,1)),s.enableVertexAttribArray(T.attributes.a_position),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.coords),s.vertexAttribPointer(T.attributes.a_position,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(T.attributes.a_normal),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.normals),s.vertexAttribPointer(T.attributes.a_normal,3,s.FLOAT,!1,0,0),R?s.disableVertexAttribArray(T.attributes.a_texCoord):(s.enableVertexAttribArray(T.attributes.a_texCoord),s.bindBuffer(s.ARRAY_BUFFER,d.compiled.texcoords),s.vertexAttribPointer(T.attributes.a_texCoord,2,s.FLOAT,!1,0,0)),s.drawArrays(s.TRIANGLES,0,d.compiled.coordCount)}}}},JSC3D.WebGLRenderBackend.prototype.renderPickingPass=function(e,r,i,t){var a=this.gl;a.disable(a.BLEND),a.enable(a.DEPTH_TEST),a.depthMask(!0),a.frontFace(a.CCW),a.viewport(0,0,this.pickingFB.width,this.pickingFB.height),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.useProgram(this.programs.picking);for(var o=0;o<e.length;o++){var n=e[o];if(!n.isTrivial()&&n.visible){var s=n.material||i;if(!(s.transparency>.99))switch(t||n.isDoubleSided?a.disable(a.CULL_FACE):a.enable(a.CULL_FACE),a.uniformMatrix4fv(this.programs.picking.uniforms.u_transformMatrix,!1,r),a.uniform3fv(this.programs.picking.uniforms.u_pickingId,n.compiled.pickingId),a.enableVertexAttribArray(this.programs.picking.attributes.a_position),n.compiled.remderMode){case"point":a.bindBuffer(a.ARRAY_BUFFER,n.compiled.coords),a.vertexAttribPointer(this.programs.picking.attributes.a_position,3,a.FLOAT,!1,0,0),a.drawArrays(a.POINTS,0,n.compiled.coordCount);break;case"wireframe":a.bindBuffer(a.ARRAY_BUFFER,n.compiled.edges),a.vertexAttribPointer(this.programs.picking.attributes.a_position,3,a.FLOAT,!1,0,0),a.drawArrays(a.LINES,0,n.compiled.edgeCount);break;case"flat":case"smooth":case"texture":case"textureflat":case"texturesmooth":default:a.bindBuffer(a.ARRAY_BUFFER,n.compiled.coords),a.vertexAttribPointer(this.programs.picking.attributes.a_position,3,a.FLOAT,!1,0,0),a.drawArrays(a.TRIANGLES,0,n.compiled.coordCount)}}}},JSC3D.WebGLRenderBackend.prototype.compileMesh=function(e,r){function i(e,r,i,t){var a,o,n,s;if(t){a=new Float32Array(18*i);for(var u=0,f=0;u<e.length;u+=4,f+=18)o=3*e[u],n=3*e[u+1],s=3*e[u+2],a[f]=r[o],a[f+1]=r[o+1],a[f+2]=r[o+2],a[f+3]=r[n],a[f+4]=r[n+1],a[f+5]=r[n+2],a[f+6]=r[n],a[f+7]=r[n+1],a[f+8]=r[n+2],a[f+9]=r[s],a[f+10]=r[s+1],a[f+11]=r[s+2],a[f+12]=r[s],a[f+13]=r[s+1],a[f+14]=r[s+2],a[f+15]=r[o],a[f+16]=r[o+1],a[f+17]=r[o+2]}else{a=[];for(var u=0,l=0;i>u;u++){for(o=3*e[l++],n=o;e[l]>0;)s=3*e[l++],a.push(r[n],r[n+1],r[n+2],r[s],r[s+1],r[s+2]),n=s;l++,a.push(r[n],r[n+1],r[n+2],r[o],r[o+1],r[o+2])}a=new Float32Array(a)}return a}if(e.isTrivial())return!1;r=e.renderMode||r;var t=this.gl,a="flat"==r||"textureflat"==r,o=e.indexBuffer.length==4*e.faceCount,n=e.texCoordBuffer&&e.texCoordBuffer.length>=2,s=e.indexBuffer,u=e.vertexBuffer,f=e.texCoordBuffer,l=e.texCoordIndexBuffer||s,d=e.vertexNormalBuffer,m=e.vertexNormalIndexBuffer||s,c=e.faceNormalBuffer,_=e.faceCount;if(e.compiled){var E="flat"==e.compiled.remderMode||"textureflat"==e.compiled.remderMode;if(E!=a){var T;if(o){T=new Float32Array(9*_);for(var R,b,A,p=0,h=0,F=0;p<s.length;p+=4,h+=9,F++)a?(R=3*F,T[h]=T[h+3]=T[h+6]=c[R],T[h+1]=T[h+4]=T[h+7]=c[R+1],T[h+2]=T[h+5]=T[h+8]=c[R+2]):(R=3*m[p],b=3*m[p+1],A=3*m[p+2],T[h]=d[R],T[h+1]=d[R+1],T[h+2]=d[R+2],T[h+3]=d[b],T[h+4]=d[b+1],T[h+5]=d[b+2],T[h+6]=d[A],T[h+7]=d[A+1],T[h+8]=d[A+2])}else{T=[];for(var R,b,A,p=0,h=0;_>p;p++){for(R=3*m[h++],b=3*m[h++];s[h]>=0;)a?(R=3*p,T.push(c[R],c[R+1],c[R+2],c[R],c[R+1],c[R+2],c[R],c[R+1],c[R+2])):(A=3*m[h],T.push(d[R],d[R+1],d[R+2],d[b],d[b+1],d[b+2],d[A],d[A+1],d[A+2]),b=A),h++;h++}T=new Float32Array(T)}this.isIE11?(t.deleteBuffer(e.compiled.normals),e.compiled.normals=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferData(t.ARRAY_BUFFER,T,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)):(t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferSubData(t.ARRAY_BUFFER,0,T),t.bindBuffer(t.ARRAY_BUFFER,null))}}else{e.compiled={isIndexed:!1},e.compiled.pickingId=new Float32Array([(16711680&e.internalId)/16777216,(65280&e.internalId)/65536,(255&e.internalId)/256]);var g,x,T,v;if(o){x=new Float32Array(9*_),T=new Float32Array(9*_),n&&(v=new Float32Array(6*_));for(var B,U,C,R,b,A,D,P,L,p=0,h=0,S=0,F=0;p<s.length;p+=4,h+=9,S+=6,F++)B=3*s[p],U=3*s[p+1],C=3*s[p+2],x[h]=u[B],x[h+1]=u[B+1],x[h+2]=u[B+2],x[h+3]=u[U],x[h+4]=u[U+1],x[h+5]=u[U+2],x[h+6]=u[C],x[h+7]=u[C+1],x[h+8]=u[C+2],a?(R=3*F,T[h]=T[h+3]=T[h+6]=c[R],T[h+1]=T[h+4]=T[h+7]=c[R+1],T[h+2]=T[h+5]=T[h+8]=c[R+2]):(R=3*m[p],b=3*m[p+1],A=3*m[p+2],T[h]=d[R],T[h+1]=d[R+1],T[h+2]=d[R+2],T[h+3]=d[b],T[h+4]=d[b+1],T[h+5]=d[b+2],T[h+6]=d[A],T[h+7]=d[A+1],T[h+8]=d[A+2]),n&&(D=2*l[p],P=2*l[p+1],L=2*l[p+2],v[S]=f[D],v[S+1]=f[D+1],v[S+2]=f[P],v[S+3]=f[P+1],v[S+4]=f[L],v[S+5]=f[L+1])}else{x=[],T=[],n&&(v=[]);for(var B,U,C,R,b,A,D,P,L,p=0,h=0;_>p;p++){for(B=3*s[h],U=3*s[h+1],R=3*m[h],b=3*m[h+1],n&&(D=2*l[h],P=2*l[h+1]),h+=2;s[h]>=0;)C=3*s[h],x.push(u[B],u[B+1],u[B+2],u[U],u[U+1],u[U+2],u[C],u[C+1],u[C+2]),U=C,a?(R=3*p,T.push(c[R],c[R+1],c[R+2],c[R],c[R+1],c[R+2],c[R],c[R+1],c[R+2])):(A=3*m[h],T.push(d[R],d[R+1],d[R+2],d[b],d[b+1],d[b+2],d[A],d[A+1],d[A+2]),b=A),n&&(L=2*l[h],v.push(f[D],f[D+1],f[P],f[P+1],f[L],f[L+1]),P=L),h++;h++}x=new Float32Array(x),T=new Float32Array(T),n&&(v=new Float32Array(v))}e.compiled.coords=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.coords),t.bufferData(t.ARRAY_BUFFER,x,t.STATIC_DRAW),e.compiled.normals=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.normals),t.bufferData(t.ARRAY_BUFFER,T,t.STATIC_DRAW),n&&(e.compiled.texcoords=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.texcoords),t.bufferData(t.ARRAY_BUFFER,v,t.STATIC_DRAW)),t.bindBuffer(t.ARRAY_BUFFER,null),e.compiled.faceCount=_,e.compiled.coordCount=x.length/3}if("wireframe"==r&&!e.compiled.edges){var g=i(s,u,_,o);e.compiled.edges=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.compiled.edges),t.bufferData(t.ARRAY_BUFFER,g,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),e.compiled.edgeCount=g.length/3}return e.compiled.remderMode=r,!0},JSC3D.WebGLRenderBackend.prototype.compileMaterial=function(e){var r=this.gl;e.compiled={diffColor:new Float32Array([(16711680&e.diffuseColor)/16777216,(65280&e.diffuseColor)/65536,(255&e.diffuseColor)/256])};for(var i=new Uint8Array(new Uint32Array(e.getPalette()).buffer),t=0;t<i.length;t+=4){var a=i[t];i[t]=i[t+2],i[t+2]=a}return e.compiled.palette=r.createTexture(),r.bindTexture(r.TEXTURE_2D,e.compiled.palette),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,256,1,0,r.RGBA,r.UNSIGNED_BYTE,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),!0},JSC3D.WebGLRenderBackend.prototype.compileTexture=function(e,r){if(!e.hasData())return!1;r=r||e.hasMipmap();var i=this.gl;e.compiled={width:e.width,height:e.height,hasMipmap:r};for(var t=new Uint8Array(new Uint32Array(e.data).buffer),a=0;a<t.length;a+=4){var o=t[a];t[a]=t[a+2],t[a+2]=o}return e.compiled.tex=i.createTexture(),i.bindTexture(i.TEXTURE_2D,e.compiled.tex),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,i.RGBA,i.UNSIGNED_BYTE,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.REPEAT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.REPEAT),r&&i.generateMipmap(i.TEXTURE_2D),i.bindTexture(i.TEXTURE_2D,null),!0};
