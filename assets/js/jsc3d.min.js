var JSC3D=JSC3D||{};JSC3D.Viewer=function(e,t){t?this.params={SceneUrl:t.SceneUrl||"",InitRotationX:t.InitRotationX||0,InitRotationY:t.InitRotationY||0,InitRotationZ:t.InitRotationZ||0,ModelColor:t.ModelColor||"#caa618",BackgroundColor1:t.BackgroundColor1||"#ffffff",BackgroundColor2:t.BackgroundColor2||"#383840",BackgroundImageUrl:t.BackgroundImageUrl||"",Background:t.Background||"on",RenderMode:t.RenderMode||"flat",Definition:t.Definition||"standard",FaceCulling:t.FaceCulling||"on",MipMapping:t.MipMapping||"off",CreaseAngle:t.CreaseAngle||-180,SphereMapUrl:t.SphereMapUrl||"",ProgressBar:t.ProgressBar||"on",Renderer:t.Renderer||"",LocalBuffers:t.LocalBuffers||"retain"}:this.params={SceneUrl:"",InitRotationX:0,InitRotationY:0,InitRotationZ:0,ModelColor:"#caa618",BackgroundColor1:"#ffffff",BackgroundColor2:"#383840",BackgroundImageUrl:"",Background:"on",RenderMode:"flat",Definition:"standard",FaceCulling:"on",MipMapping:"off",CreaseAngle:-180,SphereMapUrl:"",ProgressBar:"on",Renderer:"",LocalBuffers:"retain"},this.canvas=e,this.ctx2d=null,this.canvasData=null,this.bkgColorBuffer=null,this.colorBuffer=null,this.zBuffer=null,this.selectionBuffer=null,this.frameWidth=e.width,this.frameHeight=e.height,this.scene=null,this.defaultMaterial=null,this.sphereMap=null,this.isLoaded=!1,this.isFailed=!1,this.abortUnfinishedLoadingFn=null,this.needUpdate=!1,this.needRepaint=!1,this.initRotX=0,this.initRotY=0,this.initRotZ=0,this.zoomFactor=1,this.panning=[0,0],this.rotMatrix=new JSC3D.Matrix3x4,this.transformMatrix=new JSC3D.Matrix3x4,this.sceneUrl="",this.modelColor=13280792,this.bkgColor1=16777215,this.bkgColor2=3684416,this.bkgImageUrl="",this.bkgImage=null,this.isBackgroundOn=!0,this.renderMode="flat",this.definition="standard",this.isCullingDisabled=!1,this.isMipMappingOn=!1,this.creaseAngle=-180,this.sphereMapUrl="",this.showProgressBar=!0,this.buttonStates={},this.keyStates={},this.mouseX=0,this.mouseY=0,this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1,this.baseZoomFactor=1,this.suppressDraggingRotation=!1,this.onloadingstarted=null,this.onloadingcomplete=null,this.onloadingprogress=null,this.onloadingaborted=null,this.onloadingerror=null,this.onmousedown=null,this.onmouseup=null,this.onmousemove=null,this.onmousewheel=null,this.onmouseclick=null,this.beforeupdate=null,this.afterupdate=null,this.mouseUsage="default",this.isDefaultInputHandlerEnabled=!0,this.progressFrame=null,this.progressRectangle=null,this.messagePanel=null,this.webglBackend=null;var r=this;JSC3D.PlatformInfo.isTouchDevice?JSC3D.Hammer?JSC3D.Hammer(this.canvas).on("touch release hold drag pinch transformend",function(e){r.gestureHandler(e)}):(this.canvas.addEventListener("touchstart",function(e){r.touchStartHandler(e)},!1),this.canvas.addEventListener("touchend",function(e){r.touchEndHandler(e)},!1),this.canvas.addEventListener("touchmove",function(e){r.touchMoveHandler(e)},!1)):(this.canvas.addEventListener("mousedown",function(e){r.mouseDownHandler(e)},!1),this.canvas.addEventListener("mouseup",function(e){r.mouseUpHandler(e)},!1),this.canvas.addEventListener("mousemove",function(e){r.mouseMoveHandler(e)},!1),this.canvas.addEventListener("firefox"==JSC3D.PlatformInfo.browser?"DOMMouseScroll":"mousewheel",function(e){r.mouseWheelHandler(e)},!1),document.addEventListener("keydown",function(e){r.keyDownHandler(e)},!1),document.addEventListener("keyup",function(e){r.keyUpHandler(e)},!1))},JSC3D.Viewer.prototype.setParameter=function(e,t){this.params[e]=t},JSC3D.Viewer.prototype.init=function(){if(this.sceneUrl=this.params.SceneUrl,this.initRotX=parseFloat(this.params.InitRotationX),this.initRotY=parseFloat(this.params.InitRotationY),this.initRotZ=parseFloat(this.params.InitRotationZ),this.modelColor=parseInt("0x"+this.params.ModelColor.substring(1)),this.bkgColor1=parseInt("0x"+this.params.BackgroundColor1.substring(1)),this.bkgColor2=parseInt("0x"+this.params.BackgroundColor2.substring(1)),this.bkgImageUrl=this.params.BackgroundImageUrl,this.isBackgroundOn="on"==this.params.Background.toLowerCase(),this.renderMode=this.params.RenderMode.toLowerCase(),this.definition=this.params.Definition.toLowerCase(),this.isCullingDisabled="off"==this.params.FaceCulling.toLowerCase(),this.creaseAngle=parseFloat(this.params.CreaseAngle),this.isMipMappingOn="on"==this.params.MipMapping.toLowerCase(),this.sphereMapUrl=this.params.SphereMapUrl,this.showProgressBar="on"==this.params.ProgressBar.toLowerCase(),this.useWebGL="webgl"==this.params.Renderer.toLowerCase(),this.releaseLocalBuffers="release"==this.params.LocalBuffers.toLowerCase(),this.useWebGL&&JSC3D.PlatformInfo.supportWebGL&&JSC3D.WebGLRenderBackend)try{this.webglBackend=new JSC3D.WebGLRenderBackend(this.canvas,this.releaseLocalBuffers)}catch(e){}if(!this.webglBackend){this.useWebGL&&JSC3D.console&&JSC3D.console.logWarning("WebGL is not available. Software rendering is enabled instead.");try{this.ctx2d=this.canvas.getContext("2d"),this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)}catch(e){this.ctx2d=null,this.canvasData=null}}switch((this.canvas.width<=2||this.canvas.height<=2)&&(this.definition="standard"),this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2);break;case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height;break;case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}this.zoomFactor=1,this.panning=[0,0],this.rotMatrix.identity(),this.transformMatrix.identity(),this.isLoaded=!1,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.scene=null,this.defaultMaterial=new JSC3D.Material("default",void 0,this.modelColor,0,!0),this.webglBackend||(this.colorBuffer=new Array(this.frameWidth*this.frameHeight),this.zBuffer=new Array(this.frameWidth*this.frameHeight),this.selectionBuffer=new Array(this.frameWidth*this.frameHeight),this.bkgColorBuffer=new Array(this.frameWidth*this.frameHeight)),this.generateBackground(),this.drawBackground();var t=this;!function r(){t.doUpdate(),setTimeout(r,30)}(),this.setBackgroudImageFromUrl(this.bkgImageUrl),this.loadScene(),this.setSphereMapFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.update=function(e){this.isFailed||(e?this.needRepaint=!0:this.needUpdate=!0)},JSC3D.Viewer.prototype.rotate=function(e,t,r){this.rotMatrix.rotateAboutXAxis(e),this.rotMatrix.rotateAboutYAxis(t),this.rotMatrix.rotateAboutZAxis(r)},JSC3D.Viewer.prototype.setRenderMode=function(e){this.params.RenderMode=e,this.renderMode=e},JSC3D.Viewer.prototype.setDefinition=function(e){if((this.canvas.width<=2||this.canvas.height<=2)&&(e="standard"),e!=this.definition){this.params.Definition=e,this.definition=e;var t=this.frameWidth;switch(this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2),this.frameHeight=~~((this.canvas.height+1)/2);break;case"high":this.frameWidth=2*this.canvas.width,this.frameHeight=2*this.canvas.height;break;case"standard":default:this.frameWidth=this.canvas.width,this.frameHeight=this.canvas.height}var r=this.frameWidth/t;if(this.zoomFactor*=r,this.panning[0]*=r,this.panning[1]*=r,!this.webglBackend){var i=this.frameWidth*this.frameHeight;this.colorBuffer.length<i&&(this.colorBuffer=new Array(i)),this.zBuffer.length<i&&(this.zBuffer=new Array(i)),this.selectionBuffer.length<i&&(this.selectionBuffer=new Array(i)),this.bkgColorBuffer.length<i&&(this.bkgColorBuffer=new Array(i)),this.generateBackground()}}},JSC3D.Viewer.prototype.setBackgroudImageFromUrl=function(e){if(this.params.BackgroundImageUrl=e,this.bkgImageUrl=e,""==e)return void(this.bkgImage=null);var t=this,r=new Image;r.onload=function(){t.bkgImage=this,t.generateBackground()},r.crossOrigin="anonymous",r.src=encodeURI(e)},JSC3D.Viewer.prototype.setSphereMapFromUrl=function(e){if(this.params.SphereMapUrl=e,this.sphereMapUrl=e,""==e)return void(this.sphereMap=null);var t=this,r=new JSC3D.Texture;r.onready=function(){t.sphereMap=r,t.update()},r.createFromUrl(this.sphereMapUrl)},JSC3D.Viewer.prototype.enableDefaultInputHandler=function(e){this.isDefaultInputHandlerEnabled=e},JSC3D.Viewer.prototype.setMouseUsage=function(e){this.mouseUsage=e},JSC3D.Viewer.prototype.isWebGLEnabled=function(){return null!=this.webglBackend},JSC3D.Viewer.prototype.replaceSceneFromUrl=function(e){this.params.SceneUrl=e,this.sceneUrl=e,this.isFailed=this.isLoaded=!1,this.loadScene()},JSC3D.Viewer.prototype.replaceScene=function(e){this.params.SceneUrl="",this.sceneUrl="",this.isFailed=!1,this.isLoaded=!0,this.setupScene(e)},JSC3D.Viewer.prototype.resetScene=function(){var e=!this.scene||this.scene.isEmpty()?0:this.scene.aabb.lengthOfDiagonal();this.zoomFactor=0==e?1:(this.frameWidth<this.frameHeight?this.frameWidth:this.frameHeight)/e,this.panning=[0,0],this.rotMatrix.identity(),this.rotMatrix.rotateAboutXAxis(this.initRotX),this.rotMatrix.rotateAboutYAxis(this.initRotY),this.rotMatrix.rotateAboutZAxis(this.initRotZ)},JSC3D.Viewer.prototype.getScene=function(){return this.scene},JSC3D.Viewer.prototype.pick=function(e,t){var r=new JSC3D.PickInfo,i=this.canvas.getBoundingClientRect(),s=e-i.left,a=t-i.top;r.canvasX=s,r.canvasY=a;var o=0;if(this.webglBackend)o=this.webglBackend.pick(s,a);else{var n=s,h=a;if(null!=this.selectionBuffer&&s>=0&&s<this.canvas.width&&a>=0&&a<this.canvas.height){switch(this.definition){case"low":n=~~(n/2),h=~~(h/2);break;case"high":n*=2,h*=2;break;case"standard":}o=this.selectionBuffer[h*this.frameWidth+n],o>0&&(r.depth=this.zBuffer[h*this.frameWidth+n])}}if(o>0)for(var l=this.scene.getChildren(),f=0;f<l.length;f++)if(l[f].internalId==o){r.mesh=l[f];break}return r},JSC3D.Viewer.prototype.doUpdate=function(){(this.needUpdate||this.needRepaint)&&(null!=this.beforeupdate&&"function"==typeof this.beforeupdate&&this.beforeupdate(),this.scene?(this.needUpdate&&(this.beginScene(),this.render(),this.endScene()),this.paint()):this.drawBackground(),this.needRepaint=!1,this.needUpdate=!1,null!=this.afterupdate&&"function"==typeof this.afterupdate&&this.afterupdate())},JSC3D.Viewer.prototype.paint=function(){!this.webglBackend&&this.ctx2d&&this.ctx2d.putImageData(this.canvasData,0,0)},JSC3D.Viewer.prototype.mouseDownHandler=function(e){if(this.isLoaded){if(this.onmousedown){var t=this.pick(e.clientX,e.clientY);this.onmousedown(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}e.preventDefault(),e.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[e.button]=!0,this.mouseX=e.clientX,this.mouseY=e.clientY,this.mouseDownX=e.clientX,this.mouseDownY=e.clientY)}},JSC3D.Viewer.prototype.mouseUpHandler=function(e){if(this.isLoaded){var t;(this.onmouseup||this.onmouseclick)&&(t=this.pick(e.clientX,e.clientY)),this.onmouseup&&this.onmouseup(t.canvasX,t.canvasY,e.button,t.depth,t.mesh),this.onmouseclick&&this.mouseDownX==e.clientX&&this.mouseDownY==e.clientY&&(this.onmouseclick(t.canvasX,t.canvasY,e.button,t.depth,t.mesh),this.mouseDownX=-1,this.mouseDownY=-1),e.preventDefault(),e.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[e.button]=!1)}},JSC3D.Viewer.prototype.mouseMoveHandler=function(e){if(this.isLoaded){if(this.onmousemove){var t=this.pick(e.clientX,e.clientY);this.onmousemove(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}if(e.preventDefault(),e.stopPropagation(),this.isDefaultInputHandlerEnabled){var r=1==this.buttonStates[0],i=1==this.keyStates[16],s=1==this.keyStates[17];if(r){if(i&&"default"==this.mouseUsage||"zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=e.clientY?1.04:.96;else if(s&&"default"==this.mouseUsage||"pan"==this.mouseUsage){var a="low"==this.definition?.5:"high"==this.definition?2:1;this.panning[0]+=a*(e.clientX-this.mouseX),this.panning[1]+=a*(e.clientY-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var o=360*(e.clientY-this.mouseY)/this.canvas.width,n=360*(e.clientX-this.mouseX)/this.canvas.height;this.rotMatrix.rotateAboutXAxis(o),this.rotMatrix.rotateAboutYAxis(n)}this.mouseX=e.clientX,this.mouseY=e.clientY,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}}}},JSC3D.Viewer.prototype.mouseWheelHandler=function(e){if(this.isLoaded){if(this.onmousewheel){var t=this.pick(e.clientX,e.clientY);this.onmousewheel(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}e.preventDefault(),e.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.mouseDownX=-1,this.mouseDownY=-1,this.zoomFactor*=("firefox"==JSC3D.PlatformInfo.browser?-e.detail:e.wheelDelta)<0?1.1:.91,this.update())}},JSC3D.Viewer.prototype.touchStartHandler=function(e){if(this.isLoaded&&e.touches.length>0){var t=e.touches[0].clientX,r=e.touches[0].clientY;if(this.onmousedown){var i=this.pick(t,r);this.onmousedown(i.canvasX,i.canvasY,0,i.depth,i.mesh)}if(e.preventDefault(),e.stopPropagation(),!this.isDefaultInputHandlerEnabled)return;this.buttonStates[0]=!0,this.mouseX=t,this.mouseY=r,this.mouseDownX=t,this.mouseDownY=r}},JSC3D.Viewer.prototype.touchEndHandler=function(e){if(this.isLoaded){var t;(this.onmouseup||this.onmouseclick)&&(t=this.pick(this.mouseX,this.mouseY)),this.onmouseup&&this.onmouseup(t.canvasX,t.canvasY,0,t.depth,t.mesh),this.onmouseclick&&this.mouseDownX==e.touches[0].clientX&&this.mouseDownY==e.touches[0].clientY&&(this.onmouseclick(t.canvasX,t.canvasY,0,t.depth,t.mesh),this.mouseDownX=-1,this.mouseDownY=-1),e.preventDefault(),e.stopPropagation(),this.isDefaultInputHandlerEnabled&&(this.buttonStates[0]=!1)}},JSC3D.Viewer.prototype.touchMoveHandler=function(e){if(this.isLoaded&&e.touches.length>0){var t=e.touches[0].clientX,r=e.touches[0].clientY;if(this.onmousemove){var i=this.pick(t,r);this.onmousemove(i.canvasX,i.canvasY,0,i.depth,i.mesh)}if(e.preventDefault(),e.stopPropagation(),!this.isDefaultInputHandlerEnabled)return;if("zoom"==this.mouseUsage)this.zoomFactor*=this.mouseY<=r?1.04:.96;else if("pan"==this.mouseUsage){var s="low"==this.definition?.5:"high"==this.definition?2:1;this.panning[0]+=s*(t-this.mouseX),this.panning[1]+=s*(r-this.mouseY)}else if("default"==this.mouseUsage||"rotate"==this.mouseUsage){var a=360*(r-this.mouseY)/this.canvas.width,o=360*(t-this.mouseX)/this.canvas.height;this.rotMatrix.rotateAboutXAxis(a),this.rotMatrix.rotateAboutYAxis(o)}this.mouseX=t,this.mouseY=r,this.mouseDownX=-1,this.mouseDownY=-1,this.update()}},JSC3D.Viewer.prototype.keyDownHandler=function(e){this.isDefaultInputHandlerEnabled&&(this.keyStates[e.keyCode]=!0)},JSC3D.Viewer.prototype.keyUpHandler=function(e){this.isDefaultInputHandlerEnabled&&(this.keyStates[e.keyCode]=!1)},JSC3D.Viewer.prototype.gestureHandler=function(e){if(this.isLoaded){var t=e.gesture.center.pageX-document.body.scrollLeft,r=e.gesture.center.pageY-document.body.scrollTop,i=this.pick(t,r);switch(e.type){case"touch":this.onmousedown&&this.onmousedown(i.canvasX,i.canvasY,0,i.depth,i.mesh),this.baseZoomFactor=this.zoomFactor,this.mouseX=t,this.mouseY=r,this.mouseDownX=t,this.mouseDownY=r;break;case"release":this.onmouseup&&this.onmouseup(i.canvasX,i.canvasY,0,i.depth,i.mesh),this.onmouseclick&&this.mouseDownX==t&&this.mouseDownY==r&&this.onmouseclick(i.canvasX,i.canvasY,0,i.depth,i.mesh),this.mouseDownX=-1,this.mouseDownY=-1,this.isTouchHeld=!1;break;case"hold":this.isTouchHeld=!0,this.mouseDownX=-1,this.mouseDownY=-1;break;case"drag":if(this.onmousemove&&this.onmousemove(i.canvasX,i.canvasY,0,i.depth,i.mesh),!this.isDefaultInputHandlerEnabled)break;if(this.isTouchHeld){var s="low"==this.definition?.5:"high"==this.definition?2:1;this.panning[0]+=s*(t-this.mouseX),this.panning[1]+=s*(r-this.mouseY)}else if(!this.suppressDraggingRotation){var a=360*(r-this.mouseY)/this.canvas.width,o=360*(t-this.mouseX)/this.canvas.height;this.rotMatrix.rotateAboutXAxis(a),this.rotMatrix.rotateAboutYAxis(o)}this.mouseX=t,this.mouseY=r,this.mouseDownX=-1,this.mouseDownY=-1,this.update();break;case"pinch":if(this.onmousewheel&&this.onmousewheel(i.canvasX,i.canvasY,0,i.depth,i.mesh),!this.isDefaultInputHandlerEnabled)break;this.suppressDraggingRotation=!0,this.zoomFactor=this.baseZoomFactor*e.gesture.scale,this.mouseDownX=-1,this.mouseDownY=-1,this.update();break;case"transformend":var n=this;setTimeout(function(){n.suppressDraggingRotation=!1},250)}e.gesture.preventDefault(),e.gesture.stopPropagation()}},JSC3D.Viewer.prototype.loadScene=function(){if(this.abortUnfinishedLoadingFn&&this.abortUnfinishedLoadingFn(),this.scene=null,this.isLoaded=!1,this.update(),""==this.sceneUrl)return!1;var e=this.sceneUrl.indexOf("?"),t=-1==e?this.sceneUrl:this.sceneUrl.substring(0,e),r=t.lastIndexOf("/");-1==r&&(r=t.lastIndexOf("\\"));var i=t.substring(r+1),s=i.lastIndexOf(".");if(-1==s)return JSC3D.console&&JSC3D.console.logError("Cannot get file format for the lack of file extension."),!1;var a=i.substring(s+1),o=JSC3D.LoaderSelector.getLoader(a);if(!o)return JSC3D.console&&JSC3D.console.logError('Unsupported file format: "'+a+'".'),!1;var n=this;return o.onload=function(e){n.abortUnfinishedLoadingFn=null,n.setupScene(e),n.onloadingcomplete&&"function"==typeof n.onloadingcomplete&&n.onloadingcomplete()},o.onerror=function(e){n.scene=null,n.isLoaded=!1,n.isFailed=!0,n.abortUnfinishedLoadingFn=null,n.update(),n.reportError(e),n.onloadingerror&&"function"==typeof n.onloadingerror&&n.onloadingerror(e)},o.onprogress=function(e,t){n.showProgressBar&&n.reportProgress(e,t),n.onloadingprogress&&"function"==typeof n.onloadingprogress&&n.onloadingprogress(e,t)},o.onresource=function(e){e instanceof JSC3D.Texture&&n.isMipMappingOn&&!e.hasMipmap()&&e.generateMipmaps(),n.update()},this.abortUnfinishedLoadingFn=function(){o.abort(),n.abortUnfinishedLoadingFn=null,n.hideProgress(),n.onloadingaborted&&"function"==typeof n.onloadingaborted&&n.onloadingaborted()},o.loadFromUrl(this.sceneUrl),this.onloadingstarted&&"function"==typeof this.onloadingstarted&&this.onloadingstarted(),!0},JSC3D.Viewer.prototype.setupScene=function(e){if(this.creaseAngle>=0){var t=this.creaseAngle;e.forEachChild(function(e){e.creaseAngle=t})}if(e.init(),!e.isEmpty()){var r=e.aabb.lengthOfDiagonal(),i=this.frameWidth,s=this.frameHeight;this.zoomFactor=0==r?1:(s>i?i:s)/r,this.panning=[0,0]}this.rotMatrix.identity(),this.rotMatrix.rotateAboutXAxis(this.initRotX),this.rotMatrix.rotateAboutYAxis(this.initRotY),this.rotMatrix.rotateAboutZAxis(this.initRotZ),this.scene=e,this.isLoaded=!0,this.isFailed=!1,this.needUpdate=!1,this.needRepaint=!1,this.update(),this.hideProgress(),this.hideError()},JSC3D.Viewer.prototype.reportProgress=function(e,t){if(!this.progressFrame){var r=this.canvas.getBoundingClientRect(),i=255-((16711680&this.bkgColor1)>>16),s=255-((65280&this.bkgColor1)>>8),a=255-(255&this.bkgColor1),o="rgb("+i+","+s+","+a+")",n=window.pageXOffset+r.left+40,h=window.pageYOffset+r.top+.38*r.height,l=r.width-2*(n-r.left),f=20;this.progressFrame=document.createElement("div"),this.progressFrame.style.position="absolute",this.progressFrame.style.left=n+"px",this.progressFrame.style.top=h+"px",this.progressFrame.style.width=l+"px",this.progressFrame.style.height=f+"px",this.progressFrame.style.border="1px solid "+o,this.progressFrame.style.pointerEvents="none",document.body.appendChild(this.progressFrame),this.progressRectangle=document.createElement("div"),this.progressRectangle.style.position="absolute",this.progressRectangle.style.left=n+3+"px",this.progressRectangle.style.top=h+3+"px",this.progressRectangle.style.width="0px",this.progressRectangle.style.height=f-4+"px",this.progressRectangle.style.background=o,this.progressRectangle.style.pointerEvents="none",document.body.appendChild(this.progressRectangle),this.messagePanel||(this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=n+"px",this.messagePanel.style.top=h-16+"px",this.messagePanel.style.width=l+"px",this.messagePanel.style.height="14px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=o,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel))}"block"!=this.progressFrame.style.display&&(this.progressFrame.style.display="block",this.progressRectangle.style.display="block"),e&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.progressRectangle.style.width=(parseFloat(this.progressFrame.style.width)-4)*t+"px",this.messagePanel.innerHTML=e},JSC3D.Viewer.prototype.hideProgress=function(){this.progressFrame&&(this.messagePanel.style.display="none",this.progressFrame.style.display="none",this.progressRectangle.style.display="none")},JSC3D.Viewer.prototype.reportError=function(e){if(!this.messagePanel){var t=this.canvas.getBoundingClientRect(),r=255-((16711680&this.bkgColor1)>>16),i=255-((65280&this.bkgColor1)>>8),s=255-(255&this.bkgColor1),a="rgb("+r+","+i+","+s+")",o=window.pageXOffset+t.left+40,n=window.pageYOffset+t.top+.38*t.height,h=t.width-2*(o-t.left),l=14;this.messagePanel=document.createElement("div"),this.messagePanel.style.position="absolute",this.messagePanel.style.left=o+"px",this.messagePanel.style.top=n-16+"px",this.messagePanel.style.width=h+"px",this.messagePanel.style.height=l+"px",this.messagePanel.style.font="bold 14px Courier New",this.messagePanel.style.color=a,this.messagePanel.style.pointerEvents="none",document.body.appendChild(this.messagePanel)}"none"!=this.progressFrame.style.display&&(this.progressFrame.style.display="none",this.progressRectangle.style.display="none"),e&&"block"!=this.messagePanel.style.display&&(this.messagePanel.style.display="block"),this.messagePanel.innerHTML=e},JSC3D.Viewer.prototype.hideError=function(){this.messagePanel&&(this.messagePanel.style.display="none")},JSC3D.Viewer.prototype.generateBackground=function(){return this.webglBackend?void(this.bkgImage?this.webglBackend.setBackgroundImage(this.bkgImage):this.webglBackend.setBackgroundColors(this.bkgColor1,this.bkgColor2)):void(this.bkgImage?this.fillBackgroundWithImage():this.fillGradientBackground())},JSC3D.Viewer.prototype.fillGradientBackground=function(){for(var e=this.frameWidth,t=this.frameHeight,r=this.bkgColorBuffer,i=(16711680&this.bkgColor1)>>16,s=(65280&this.bkgColor1)>>8,a=255&this.bkgColor1,o=(16711680&this.bkgColor2)>>16,n=(65280&this.bkgColor2)>>8,h=255&this.bkgColor2,l=this.isBackgroundOn?4278190080:0,f=0,u=0;t>u;u++)for(var d=i+u*(o-i)/t&255,p=s+u*(n-s)/t&255,m=a+u*(h-a)/t&255,c=0;e>c;c++)r[f++]=l|d<<16|p<<8|m},JSC3D.Viewer.prototype.fillBackgroundWithImage=function(){var e=this.frameWidth,t=this.frameHeight;if(!(this.bkgImage.width<=0||this.bkgImage.height<=0)){var r=!1,i=JSC3D.Texture.cv;if(!i)try{i=document.createElement("canvas"),JSC3D.Texture.cv=i,r=!0}catch(s){return}(i.width!=e||i.height!=t)&&(i.width=e,i.height=t,r=!0);var a=null;try{var o=i.getContext("2d");r||o.clearRect(0,0,e,t),o.drawImage(this.bkgImage,0,0,e,t);var n=o.getImageData(0,0,e,t);a=n.data}catch(s){return}for(var h=this.bkgColorBuffer,l=e*t,f=this.isBackgroundOn?4278190080:0,u=0,d=0;l>u;u++,d+=4)h[u]=f|a[d]<<16|a[d+1]<<8|a[d+2]}},JSC3D.Viewer.prototype.drawBackground=function(){(this.webglBackend||this.ctx2d)&&(this.beginScene(),this.endScene(),this.paint())},JSC3D.Viewer.prototype.beginScene=function(){if(this.webglBackend)return void this.webglBackend.beginFrame(this.definition,this.isBackgroundOn);for(var e=this.colorBuffer,t=this.zBuffer,r=this.selectionBuffer,i=this.bkgColorBuffer,s=this.frameWidth*this.frameHeight,a=-(1/0),o=0;s>o;o++)e[o]=i[o],t[o]=a,r[o]=0},JSC3D.Viewer.prototype.endScene=function(){if(this.webglBackend)return void this.webglBackend.endFrame();var e=this.canvasData.data,t=this.canvas.width,r=this.canvas.height,i=this.colorBuffer,s=this.frameWidth,a=this.frameHeight,o=s*a;switch(this.definition){case"low":for(var n=t>>1,h=s-n,l=0,f=0,u=0;r>u;u++){for(var d=0;t>d;d++){var p=i[l];e[f]=(16711680&p)>>16,e[f+1]=(65280&p)>>8,e[f+2]=255&p,e[f+3]=p>>>24,l+=1&d,f+=4}l+=1&u?h:-n}break;case"high":for(var l=0,f=0,u=0;r>u;u++){for(var d=0;t>d;d++){var m=i[l],c=i[l+1],g=i[l+s],v=i[l+s+1];e[f]=(16711680&m)+(16711680&c)+(16711680&g)+(16711680&v)>>18,e[f+1]=(65280&m)+(65280&c)+(65280&g)+(65280&v)>>10,e[f+2]=(255&m)+(255&c)+(255&g)+(255&v)>>2,e[f+3]=m>>>24,l+=2,f+=4}l+=s}break;case"standard":default:for(var l=0,f=0;o>l;l++,f+=4){var p=i[l];e[f]=(16711680&p)>>16,e[f+1]=(65280&p)>>8,e[f+2]=255&p,e[f+3]=p>>>24}}},JSC3D.Viewer.prototype.render=function(){if(!this.scene.isEmpty()){var e=this.scene.aabb;if(this.webglBackend){var t=this.frameWidth,r=this.frameHeight,i=e.lengthOfDiagonal();this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(e.minX+e.maxX),-.5*(e.minY+e.maxY),-.5*(e.minZ+e.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(2*this.zoomFactor/t,2*this.zoomFactor/r,-2/i),this.transformMatrix.translate(2*this.panning[0]/t,-2*this.panning[1]/r,0)}else this.transformMatrix.identity(),this.transformMatrix.translate(-.5*(e.minX+e.maxX),-.5*(e.minY+e.maxY),-.5*(e.minZ+e.maxZ)),this.transformMatrix.multiply(this.rotMatrix),this.transformMatrix.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor),this.transformMatrix.translate(.5*this.frameWidth+this.panning[0],.5*this.frameHeight+this.panning[1],0);var s=this.sortScene(this.transformMatrix);if(this.webglBackend)return void this.webglBackend.render(this.scene.getChildren(),this.transformMatrix,this.rotMatrix,this.renderMode,this.defaultMaterial,this.sphereMap,this.isCullingDisabled);for(var a=0;a<s.length;a++){var o=s[a];if(!o.isTrivial()&&(JSC3D.Math3D.transformVectors(this.transformMatrix,o.vertexBuffer,o.transformedVertexBuffer),o.visible))switch(o.renderMode||this.renderMode){case"point":this.renderPoint(o);break;case"wireframe":this.renderWireframe(o);break;case"flat":this.renderSolidFlat(o);break;case"smooth":this.renderSolidSmooth(o);break;case"texture":o.hasTexture()?this.renderSolidTexture(o):this.renderSolidFlat(o);break;case"textureflat":o.hasTexture()?this.renderTextureFlat(o):this.renderSolidFlat(o);break;case"texturesmooth":o.isEnvironmentCast&&null!=this.sphereMap&&this.sphereMap.hasData()?this.renderSolidSphereMapped(o):o.hasTexture()?this.renderTextureSmooth(o):this.renderSolidSmooth(o);break;default:this.renderSolidFlat(o)}}}},JSC3D.Viewer.prototype.sortScene=function(e){for(var t=[],r=this.scene.getChildren(),i=0;i<r.length;i++){var s=r[i];if(!s.isTrivial()){t.push(s);var a=s.aabb.center();JSC3D.Math3D.transformVectors(e,a,a);var o=s.material?s.material:this.defaultMaterial;s.sortKey={depth:a[2],isTransparnt:o.transparency>0||(s.hasTexture()?s.texture.hasTransparency:!1)}}}return t.sort(function(e,t){return!e.sortKey.isTransparnt&&t.sortKey.isTransparnt?-1:e.sortKey.isTransparnt&&!t.sortKey.isTransparnt?1:e.sortKey.isTransparnt?e.sortKey.depth-t.sortKey.depth:t.sortKey.depth-e.sortKey.depth}),t},JSC3D.Viewer.prototype.renderPoint=function(e){for(var t=this.frameWidth,r=this.frameHeight,i=t-1,s=r-1,a=(e.indexBuffer,e.transformedVertexBuffer),o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=a.length/3,f=e.internalId,u=4278190080|(e.material?e.material.diffuseColor:this.defaultMaterial.diffuseColor),d=0,p=0;l>d;d++,p+=3){var m=~~(a[p]+.5),c=~~(a[p+1]+.5),g=a[p+2];if(m>=0&&i>m&&c>=0&&s>c){var v=c*t+m;g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v++,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v+=i,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f),v++,g>n[v]&&(n[v]=g,o[v]=u,h[v]=f)}}},JSC3D.Viewer.prototype.renderWireframe=function(e){var t=this.frameWidth,r=this.frameHeight,i=t-1,s=r-1,a=e.indexBuffer,o=e.transformedVertexBuffer,n=e.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=e.faceCount,d=e.internalId,p=4278190080|(e.material?e.material.diffuseColor:this.defaultMaterial.diffuseColor),m=e.isDoubleSided||this.isCullingDisabled;(!n||n.length<u)&&(e.transformedFaceNormalZBuffer=new Array(u),n=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,n);for(var c=0,g=0;u>c;){var v=n[c++];if(m&&(v=v>0?v:-v),0>v){do;while(-1!=a[g++])}else{var C,y,S;y=3*a[g++],S=3*a[g++],C=y;for(var x=!1;!x;){var D,b,w,B,J=~~(o[y]+.5),M=~~(o[y+1]+.5),k=o[y+2],F=~~(o[S]+.5),I=~~(o[S+1]+.5),V=o[S+2],A=F-J,N=I-M,L=V-k;Math.abs(A)>Math.abs(N)?(D=A,b=A>0?1:-1,w=0!=A?b*N/A:0,B=0!=A?b*L/A:0):(D=N,w=N>0?1:-1,b=0!=N?w*A/N:0,B=0!=N?w*L/N:0);var Y=J,U=M,X=k;0>D&&(Y=F,U=I,X=V,D=-D,b=-b,w=-w,B=-B);for(var T=0;D>T;T++){if(Y>=0&&i>Y&&U>=0&&s>U){var Z=~~U*t+~~Y;X>l[Z]&&(l[Z]=X,h[Z]=p,f[Z]=d)}Y+=b,U+=w,X+=B}S==C?x=!0:(y=S,S=-1!=a[g]?3*a[g++]:C)}g++}}},JSC3D.Viewer.prototype.renderSolidFlat=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=e.faceCount,f=e.internalId,u=e.material?e.material:this.defaultMaterial,d=u.getPalette(),p=0==u.transparency,m=~~(255*u.transparency),c=255-m,g=e.isDoubleSided||this.isCullingDisabled;if(1!=u.transparency){(!a||a.length<l)&&(e.transformedFaceNormalZBuffer=new Array(l),a=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,a);for(var v=new Array(3),C=new Array(3),y=new Array(3),S=0,x=0;l>S;){var D=a[S++];if(g&&(D=D>0?D:-D),0>D){do;while(-1!=i[x++])}else{var b,w,B,J=4278190080|d[~~(255*D)];b=3*i[x++],w=3*i[x++];do{B=3*i[x++],v[0]=~~(s[b]+.5),C[0]=~~(s[b+1]+.5),y[0]=s[b+2],v[1]=~~(s[w]+.5),C[1]=~~(s[w+1]+.5),y[1]=s[w+2],v[2]=~~(s[B]+.5),C[2]=~~(s[B+1]+.5),y[2]=s[B+2];var M=C[0]<C[1]?0:1;M=C[M]<C[2]?M:2;var k=C[0]>C[1]?0:1;k=C[k]>C[2]?k:2;var F=3-k-M;if(M!=k){var I=v[k],V=y[k],A=C[k]-C[M];A=0!=A?A:1;var N=(v[k]-v[M])/A,L=(y[k]-y[M])/A,Y=v[k],U=y[k],X=C[k]-C[F];X=0!=X?X:1;var T=(v[k]-v[F])/X,Z=(y[k]-y[F])/X,P=v[F],R=y[F],H=C[F]-C[M];H=0!=H?H:1;for(var E=(v[F]-v[M])/H,W=(y[F]-y[M])/H,O=C[k]*t,z=C[k];z>C[M];z--){if(z>=0&&r>z){var q,j,G=~~I,K=V;if(z>C[F]?(q=~~Y,j=U):(q=~~P,j=R),G>q){var _;_=G,G=q,q=_,_=K,K=j,j=_}0>G&&(G=0),q>=t&&(q=t-1);var Q=G!=q?(j-K)/(q-G):1,$=O+G;if(p)for(var ee=G,te=K;q>=ee;ee++,te+=Q)te>n[$]&&(n[$]=te,o[$]=J,h[$]=f),$++;else for(var ee=G,te=K;q>ee;ee++,te+=Q){if(te>n[$]){var re=J,ie=o[$],se=(16711680&ie)*m+(16711680&re)*c>>8,ae=(65280&ie)*m+(65280&re)*c>>8,oe=(255&ie)*m+(255&re)*c>>8,ne=4278190080&ie|c<<24;o[$]=ne|16711680&se|65280&ae|255&oe,h[$]=f}$++}}I-=N,V-=L,z>C[F]?(Y-=T,U-=Z):(P-=E,R-=W),O-=t}}w=B}while(-1!=i[x]);x++}}}},JSC3D.Viewer.prototype.renderSolidSmooth=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedVertexNormalZBuffer,o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer,n=e.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=e.faceCount,d=(s.length/3,e.internalId),p=e.material?e.material:this.defaultMaterial,m=p.getPalette(),c=0==p.transparency,g=~~(255*p.transparency),v=255-g,C=e.isDoubleSided||this.isCullingDisabled;if(1!=p.transparency){(!a||a.length<e.vertexNormalBuffer.length/3)&&(e.transformedVertexNormalZBuffer=new Array(e.vertexNormalBuffer.length/3),a=e.transformedVertexNormalZBuffer),(!n||n.length<u)&&(e.transformedFaceNormalZBuffer=new Array(u),n=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,n);for(var y=new Array(3),S=new Array(3),x=new Array(3),D=new Array(3),b=0,w=0;u>b;){var B=n[b++];if(C&&(B=B>0?B:-B),0>B){do;while(-1!=i[w++])}else{var J,M,k,F,I,V,A,N,L;J=i[w],F=3*J,A=o[w],w++,M=i[w],I=3*M,N=o[w],w++;do{k=i[w],V=3*k,L=o[w],w++,y[0]=~~(s[F]+.5),S[0]=~~(s[F+1]+.5),x[0]=s[F+2],y[1]=~~(s[I]+.5),S[1]=~~(s[I+1]+.5),x[1]=s[I+2],y[2]=~~(s[V]+.5),S[2]=~~(s[V+1]+.5),x[2]=s[V+2],D[0]=a[A],D[1]=a[N],D[2]=a[L],C&&(D[0]<0&&(D[0]=-D[0]),D[1]<0&&(D[1]=-D[1]),D[2]<0&&(D[2]=-D[2]));var Y=S[0]<S[1]?0:1;Y=S[Y]<S[2]?Y:2;var U=S[0]>S[1]?0:1;U=S[U]>S[2]?U:2;var X=3-U-Y;if(Y!=U){var T=y[U],Z=x[U],P=255*D[U],R=S[U]-S[Y];R=0!=R?R:1;var H=(y[U]-y[Y])/R,E=(x[U]-x[Y])/R,W=255*(D[U]-D[Y])/R,O=y[U],z=x[U],q=255*D[U],j=S[U]-S[X];j=0!=j?j:1;var G=(y[U]-y[X])/j,K=(x[U]-x[X])/j,_=255*(D[U]-D[X])/j,Q=y[X],$=x[X],ee=255*D[X],te=S[X]-S[Y];te=0!=te?te:1;for(var re=(y[X]-y[Y])/te,ie=(x[X]-x[Y])/te,se=255*(D[X]-D[Y])/te,ae=S[U]*t,oe=S[U];oe>S[Y];oe--){
if(oe>=0&&r>oe){var ne,he,le,fe=~~T,ue=Z,de=P;if(oe>S[X]?(ne=~~O,he=z,le=q):(ne=~~Q,he=$,le=ee),fe>ne){var pe;pe=fe,fe=ne,ne=pe,pe=ue,ue=he,he=pe,pe=de,de=le,le=pe}var me=fe!=ne?(he-ue)/(ne-fe):1,ce=fe!=ne?(le-de)/(ne-fe):1;0>fe&&(ue-=fe*me,de-=fe*ce,fe=0),ne>=t&&(ne=t-1);var ge=ae+fe;if(c)for(var ve=fe,Ce=ue,ye=de;ne>=ve;ve++,Ce+=me,ye+=ce)Ce>l[ge]&&(l[ge]=Ce,h[ge]=4278190080|m[ye>0?~~ye:0],f[ge]=d),ge++;else for(var ve=fe,Ce=ue,ye=de;ne>ve;ve++,Ce+=me,ye+=ce){if(Ce>l[ge]){var Se=m[ye>0?~~ye:0],xe=h[ge],De=(16711680&xe)*g+(16711680&Se)*v>>8,be=(65280&xe)*g+(65280&Se)*v>>8,we=(255&xe)*g+(255&Se)*v>>8,Be=4278190080&xe|v<<24;h[ge]=Be|16711680&De|65280&be|255&we,f[ge]=d}ge++}}T-=H,Z-=E,P-=W,oe>S[X]?(O-=G,z-=K,q-=_):(Q-=re,$-=ie,ee-=se),ae-=t}}I=V,M=k,N=L}while(-1!=i[w]);w++}}}},JSC3D.Viewer.prototype.renderSolidTexture=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=e.faceCount,f=e.internalId,u=e.texture,d=!u.hasTransparency,p=e.texCoordBuffer,m=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer,c=u.data,g=u.width,v=g-1,C=u.hasMipmap()?u.mipmaps:null,y=C?u.mipentries:null,S=e.isDoubleSided||this.isCullingDisabled;(!a||a.length<l)&&(e.transformedFaceNormalZBuffer=new Array(l),a=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,a);for(var x=new Array(3),D=new Array(3),b=new Array(3),w=new Array(3),B=new Array(3),J=0,M=0;l>J;){var k=a[J++];if(S&&(k=k>0?k:-k),0>k){do;while(-1!=i[M++])}else{var F,I,V,A,N,L;if(F=3*i[M],A=2*m[M],M++,I=3*i[M],N=2*m[M],M++,C){V=3*i[M],L=2*m[M],g=u.width,x[0]=s[F],D[0]=s[F+1],x[1]=s[I],D[1]=s[I+1],x[2]=s[V],D[2]=s[V+1],w[0]=p[A]*g,B[0]=p[A+1]*g,w[1]=p[N]*g,B[1]=p[N+1]*g,w[2]=p[L]*g,B[2]=p[L+1]*g;var Y=(x[1]-x[0])*(D[2]-D[0])-(D[1]-D[0])*(x[2]-x[0]);0>Y&&(Y=-Y),Y+=1;var U=(w[1]-w[0])*(B[2]-B[0])-(B[1]-B[0])*(w[2]-w[0]);0>U&&(U=-U);var X=U/Y,T=0;if(X<y[1])T=0;else if(X>=y[y.length-1])T=y.length-1,g=1;else for(;X>=y[T+1];)T++,g/=2;c=C[T],v=g-1}do{V=3*i[M],L=2*m[M],M++,x[0]=~~(s[F]+.5),D[0]=~~(s[F+1]+.5),b[0]=s[F+2],x[1]=~~(s[I]+.5),D[1]=~~(s[I+1]+.5),b[1]=s[I+2],x[2]=~~(s[V]+.5),D[2]=~~(s[V+1]+.5),b[2]=s[V+2],w[0]=p[A]*g,B[0]=p[A+1]*g,w[1]=p[N]*g,B[1]=p[N+1]*g,w[2]=p[L]*g,B[2]=p[L+1]*g;var Z=D[0]<D[1]?0:1;Z=D[Z]<D[2]?Z:2;var P=D[0]>D[1]?0:1;P=D[P]>D[2]?P:2;var R=3-P-Z;if(Z!=P){var H=x[P],E=b[P],W=w[P],O=B[P],z=D[P]-D[Z];z=0!=z?z:1;var q=(x[P]-x[Z])/z,j=(b[P]-b[Z])/z,G=(w[P]-w[Z])/z,K=(B[P]-B[Z])/z,_=x[P],Q=b[P],$=w[P],ee=B[P],te=D[P]-D[R];te=0!=te?te:1;var re=(x[P]-x[R])/te,ie=(b[P]-b[R])/te,se=(w[P]-w[R])/te,ae=(B[P]-B[R])/te,oe=x[R],ne=b[R],he=w[R],le=B[R],fe=D[R]-D[Z];fe=0!=fe?fe:1;for(var ue=(x[R]-x[Z])/fe,de=(b[R]-b[Z])/fe,pe=(w[R]-w[Z])/fe,me=(B[R]-B[Z])/fe,ce=D[P]*t,ge=D[P];ge>D[Z];ge--){if(ge>=0&&r>ge){var ve,Ce,ye,Se,xe=~~H,De=E,be=W,we=O;if(ge>D[R]?(ve=~~_,Ce=Q,ye=$,Se=ee):(ve=~~oe,Ce=ne,ye=he,Se=le),xe>ve){var Be;Be=xe,xe=ve,ve=Be,Be=De,De=Ce,Ce=Be,Be=be,be=ye,ye=Be,Be=we,we=Se,Se=Be}var Je=xe!=ve?(Ce-De)/(ve-xe):1,Me=xe!=ve?(ye-be)/(ve-xe):1,ke=xe!=ve?(Se-we)/(ve-xe):1;0>xe&&(De-=xe*Je,be-=xe*Me,we-=xe*ke,xe=0),ve>=t&&(ve=t-1);var Fe=ce+xe;if(d)for(var Ie=xe,Ve=De,Ae=be,Ne=we;ve>=Ie;Ie++,Ve+=Je,Ae+=Me,Ne+=ke)Ve>n[Fe]&&(n[Fe]=Ve,o[Fe]=c[(Ne&v)*g+(Ae&v)],h[Fe]=f),Fe++;else for(var Ie=xe,Ve=De,Ae=be,Ne=we;ve>Ie;Ie++,Ve+=Je,Ae+=Me,Ne+=ke){if(Ve>n[Fe]){var Le=c[(Ne&v)*g+(Ae&v)],Ye=o[Fe],Ue=Le>>24&255,Xe=255-Ue,Te=(16711680&Ye)*Xe+(16711680&Le)*Ue>>8,Ze=(65280&Ye)*Xe+(65280&Le)*Ue>>8,Pe=(255&Ye)*Xe+(255&Le)*Ue>>8,Re=4278190080&Ye|Ue<<24;o[Fe]=Re|16711680&Te|65280&Ze|255&Pe,h[Fe]=f}Fe++}}H-=q,E-=j,W-=G,O-=K,ge>D[R]?(_-=re,Q-=ie,$-=se,ee-=ae):(oe-=ue,ne-=de,he-=pe,le-=me),ce-=t}}I=V,N=L}while(-1!=i[M]);M++}}},JSC3D.Viewer.prototype.renderTextureFlat=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedFaceNormalZBuffer,o=this.colorBuffer,n=this.zBuffer,h=this.selectionBuffer,l=e.faceCount,f=e.internalId,u=e.material?e.material:this.defaultMaterial,d=u.getPalette(),p=e.texture,m=0==u.transparency&&!p.hasTransparency,c=~~(255*(1-u.transparency)),g=e.texCoordBuffer,v=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer,C=p.data,y=p.width,S=y-1,x=p.hasMipmap()?p.mipmaps:null,D=x?p.mipentries:null,b=e.isDoubleSided||this.isCullingDisabled;if(1!=u.transparency){(!a||a.length<l)&&(e.transformedFaceNormalZBuffer=new Array(l),a=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,a);for(var w=new Array(3),B=new Array(3),J=new Array(3),M=new Array(3),k=new Array(3),F=0,I=0;l>F;){var V=a[F++];if(b&&(V=V>0?V:-V),0>V){do;while(-1!=i[I++])}else{var A,N,L,Y,U,X,T=4278190080|d[~~(255*V)];if(A=3*i[I],Y=2*v[I],I++,N=3*i[I],U=2*v[I],I++,x){L=3*i[I],X=2*v[I],y=p.width,w[0]=s[A],B[0]=s[A+1],w[1]=s[N],B[1]=s[N+1],w[2]=s[L],B[2]=s[L+1],M[0]=g[Y]*y,k[0]=g[Y+1]*y,M[1]=g[U]*y,k[1]=g[U+1]*y,M[2]=g[X]*y,k[2]=g[X+1]*y;var Z=(w[1]-w[0])*(B[2]-B[0])-(B[1]-B[0])*(w[2]-w[0]);0>Z&&(Z=-Z),Z+=1;var P=(M[1]-M[0])*(k[2]-k[0])-(k[1]-k[0])*(M[2]-M[0]);0>P&&(P=-P);var R=P/Z,H=0;if(R<D[1])H=0;else if(R>=D[D.length-1])H=D.length-1,y=1;else for(;R>=D[H+1];)H++,y/=2;C=x[H],S=y-1}do{L=3*i[I],X=2*v[I],I++,w[0]=~~(s[A]+.5),B[0]=~~(s[A+1]+.5),J[0]=s[A+2],w[1]=~~(s[N]+.5),B[1]=~~(s[N+1]+.5),J[1]=s[N+2],w[2]=~~(s[L]+.5),B[2]=~~(s[L+1]+.5),J[2]=s[L+2],M[0]=g[Y]*y,k[0]=g[Y+1]*y,M[1]=g[U]*y,k[1]=g[U+1]*y,M[2]=g[X]*y,k[2]=g[X+1]*y;var E=B[0]<B[1]?0:1;E=B[E]<B[2]?E:2;var W=B[0]>B[1]?0:1;W=B[W]>B[2]?W:2;var O=3-W-E;if(E!=W){var z=w[W],q=J[W],j=M[W],G=k[W],K=B[W]-B[E];K=0!=K?K:1;var _=(w[W]-w[E])/K,Q=(J[W]-J[E])/K,$=(M[W]-M[E])/K,ee=(k[W]-k[E])/K,te=w[W],re=J[W],ie=M[W],se=k[W],ae=B[W]-B[O];ae=0!=ae?ae:1;var oe=(w[W]-w[O])/ae,ne=(J[W]-J[O])/ae,he=(M[W]-M[O])/ae,le=(k[W]-k[O])/ae,fe=w[O],ue=J[O],de=M[O],pe=k[O],me=B[O]-B[E];me=0!=me?me:1;for(var ce=(w[O]-w[E])/me,ge=(J[O]-J[E])/me,ve=(M[O]-M[E])/me,Ce=(k[O]-k[E])/me,ye=B[W]*t,Se=B[W];Se>B[E];Se--){if(Se>=0&&r>Se){var xe,De,be,we,Be=~~z,Je=q,Me=j,ke=G;if(Se>B[O]?(xe=~~te,De=re,be=ie,we=se):(xe=~~fe,De=ue,be=de,we=pe),Be>xe){var Fe;Fe=Be,Be=xe,xe=Fe,Fe=Je,Je=De,De=Fe,Fe=Me,Me=be,be=Fe,Fe=ke,ke=we,we=Fe}var Ie=Be!=xe?(De-Je)/(xe-Be):1,Ve=Be!=xe?(be-Me)/(xe-Be):1,Ae=Be!=xe?(we-ke)/(xe-Be):1;0>Be&&(Je-=Be*Ie,Me-=Be*Ve,ke-=Be*Ae,Be=0),xe>=t&&(xe=t-1);var Ne=ye+Be;if(m)for(var Le=Be,Ye=Je,Ue=Me,Xe=ke;xe>=Le;Le++,Ye+=Ie,Ue+=Ve,Xe+=Ae){if(Ye>n[Ne]){n[Ne]=Ye;var Te=C[(Xe&S)*y+(Ue&S)],Ze=((16711680&T)>>16)*((16711680&Te)>>8),Pe=((65280&T)>>8)*((65280&Te)>>8),Re=(255&T)*(255&Te)>>8;o[Ne]=4278190080|16711680&Ze|65280&Pe|255&Re,h[Ne]=f}Ne++}else for(var Le=Be,Ye=Je,Ue=Me,Xe=ke;xe>Le;Le++,Ye+=Ie,Ue+=Ve,Xe+=Ae){if(Ye>n[Ne]){var He=C[(Xe&S)*y+(Ue&S)],Ee=o[Ne],We=(He>>24&255)*(255&c)>>8,Ze=((16711680&T)>>16)*((16711680&He)>>8),Pe=((65280&T)>>8)*((65280&He)>>8),Re=(255&T)*(255&He)>>8,Oe=4278190080&Ee|We<<24;if(We>250)n[Ne]=Ye;else{var ze=255-We;Ze=Ze*We+(16711680&Ee)*ze>>8,Pe=Pe*We+(65280&Ee)*ze>>8,Re=Re*We+(255&Ee)*ze>>8}o[Ne]=Oe|16711680&Ze|65280&Pe|255&Re,h[Ne]=f}Ne++}}z-=_,q-=Q,j-=$,G-=ee,Se>B[O]?(te-=oe,re-=ne,ie-=he,se-=le):(fe-=ce,ue-=ge,de-=ve,pe-=Ce),ye-=t}}N=L,U=X}while(-1!=i[I]);I++}}}},JSC3D.Viewer.prototype.renderTextureSmooth=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedVertexNormalZBuffer,o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer,n=e.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=e.faceCount,d=e.internalId,p=(s.length/3,e.material?e.material:this.defaultMaterial),m=p.getPalette(),c=e.texture,g=0==p.transparency&&!c.hasTransparency,v=~~(255*(1-p.transparency)),C=e.texCoordBuffer,y=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer,S=c.data,x=c.width,D=x-1,b=c.hasMipmap()?c.mipmaps:null,w=b?c.mipentries:null,B=e.isDoubleSided||this.isCullingDisabled;if(1!=p.transparency){(!a||a.length<e.vertexNormalBuffer.length/3)&&(e.transformedVertexNormalZBuffer=new Array(e.vertexNormalBuffer.length/3),a=e.transformedVertexNormalZBuffer),(!n||n.length<u)&&(e.transformedFaceNormalZBuffer=new Array(u),n=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,n);for(var J=new Array(3),M=new Array(3),k=new Array(3),F=new Array(3),I=new Array(3),V=new Array(3),A=0,N=0;u>A;){var L=n[A++];if(B&&(L=L>0?L:-L),0>L){do;while(-1!=i[N++])}else{var Y,U,X,T,Z,P,R,H,E,W,O,z;if(Y=i[N],T=3*Y,R=2*y[N],W=o[N],N++,U=i[N],Z=3*U,H=2*y[N],O=o[N],N++,b){P=3*i[N],E=2*y[N],x=c.width,J[0]=s[T],M[0]=s[T+1],J[1]=s[Z],M[1]=s[Z+1],J[2]=s[P],M[2]=s[P+1],I[0]=C[R]*x,V[0]=C[R+1]*x,I[1]=C[H]*x,V[1]=C[H+1]*x,I[2]=C[E]*x,V[2]=C[E+1]*x;var q=(J[1]-J[0])*(M[2]-M[0])-(M[1]-M[0])*(J[2]-J[0]);0>q&&(q=-q),q+=1;var j=(I[1]-I[0])*(V[2]-V[0])-(V[1]-V[0])*(I[2]-I[0]);0>j&&(j=-j);var G=j/q,K=0;if(G<w[1])K=0;else if(G>=w[w.length-1])K=w.length-1,x=1;else for(;G>=w[K+1];)K++,x/=2;S=b[K],D=x-1}do{X=i[N],P=3*X,E=2*y[N],z=o[N],N++,J[0]=~~(s[T]+.5),M[0]=~~(s[T+1]+.5),k[0]=s[T+2],J[1]=~~(s[Z]+.5),M[1]=~~(s[Z+1]+.5),k[1]=s[Z+2],J[2]=~~(s[P]+.5),M[2]=~~(s[P+1]+.5),k[2]=s[P+2],I[0]=C[R]*x,V[0]=C[R+1]*x,I[1]=C[H]*x,V[1]=C[H+1]*x,I[2]=C[E]*x,V[2]=C[E+1]*x,F[0]=a[W],F[1]=a[O],F[2]=a[z],B&&(F[0]<0&&(F[0]=-F[0]),F[1]<0&&(F[1]=-F[1]),F[2]<0&&(F[2]=-F[2]));var _=M[0]<M[1]?0:1;_=M[_]<M[2]?_:2;var Q=M[0]>M[1]?0:1;Q=M[Q]>M[2]?Q:2;var $=3-Q-_;if(_!=Q){var ee=J[Q],te=k[Q],re=I[Q],ie=V[Q],se=255*F[Q],ae=M[Q]-M[_];ae=0!=ae?ae:1;var oe=(J[Q]-J[_])/ae,ne=(k[Q]-k[_])/ae,he=(I[Q]-I[_])/ae,le=(V[Q]-V[_])/ae,fe=255*(F[Q]-F[_])/ae,ue=J[Q],de=k[Q],pe=I[Q],me=V[Q],ce=255*F[Q],ge=M[Q]-M[$];ge=0!=ge?ge:1;var ve=(J[Q]-J[$])/ge,Ce=(k[Q]-k[$])/ge,ye=(I[Q]-I[$])/ge,Se=(V[Q]-V[$])/ge,xe=255*(F[Q]-F[$])/ge,De=J[$],be=k[$],we=I[$],Be=V[$],Je=255*F[$],Me=M[$]-M[_];Me=0!=Me?Me:1;for(var ke=(J[$]-J[_])/Me,Fe=(k[$]-k[_])/Me,Ie=(I[$]-I[_])/Me,Ve=(V[$]-V[_])/Me,Ae=255*(F[$]-F[_])/Me,Ne=M[Q]*t,Le=M[Q];Le>M[_];Le--){if(Le>=0&&r>Le){var Ye,Ue,Xe,Te,Ze,Pe=~~ee,Re=te,He=re,Ee=ie,We=se;if(Le>M[$]?(Ye=~~ue,Ue=de,Xe=pe,Te=me,Ze=ce):(Ye=~~De,Ue=be,Xe=we,Te=Be,Ze=Je),Pe>Ye){var Oe;Oe=Pe,Pe=Ye,Ye=Oe,Oe=Re,Re=Ue,Ue=Oe,Oe=He,He=Xe,Xe=Oe,Oe=Ee,Ee=Te,Te=Oe,Oe=We,We=Ze,Ze=Oe}var ze=Pe!=Ye?(Ue-Re)/(Ye-Pe):1,qe=Pe!=Ye?(Xe-He)/(Ye-Pe):1,je=Pe!=Ye?(Te-Ee)/(Ye-Pe):1,Ge=Pe!=Ye?(Ze-We)/(Ye-Pe):0;0>Pe&&(Re-=Pe*ze,He-=Pe*qe,Ee-=Pe*je,We-=Pe*Ge,Pe=0),Ye>=t&&(Ye=t-1);var Ke=Ne+Pe;if(g)for(var _e=Pe,Qe=Re,$e=We,et=He,tt=Ee;Ye>=_e;_e++,Qe+=ze,$e+=Ge,et+=qe,tt+=je){if(Qe>l[Ke]){l[Ke]=Qe;var rt=m[$e>0?~~$e:0],it=S[(tt&D)*x+(et&D)],st=((16711680&rt)>>16)*((16711680&it)>>8),at=((65280&rt)>>8)*((65280&it)>>8),ot=(255&rt)*(255&it)>>8;h[Ke]=4278190080|16711680&st|65280&at|255&ot,f[Ke]=d}Ke++}else for(var _e=Pe,Qe=Re,$e=We,et=He,tt=Ee;Ye>_e;_e++,Qe+=ze,$e+=Ge,et+=qe,tt+=je){if(Qe>l[Ke]){var rt=m[$e>0?~~$e:0],nt=S[(tt&D)*x+(et&D)],ht=h[Ke],lt=(nt>>24&255)*(255&v)>>8,st=((16711680&rt)>>16)*((16711680&nt)>>8),at=((65280&rt)>>8)*((65280&nt)>>8),ot=(255&rt)*(255&nt)>>8,ft=4278190080&ht|lt<<24;if(lt>250)l[Ke]=Qe;else{var ut=255-lt;st=st*lt+(16711680&ht)*ut>>8,at=at*lt+(65280&ht)*ut>>8,ot=ot*lt+(255&ht)*ut>>8}h[Ke]=ft|16711680&st|65280&at|255&ot,f[Ke]=d}Ke++}}ee-=oe,te-=ne,re-=he,ie-=le,se-=fe,Le>M[$]?(ue-=ve,de-=Ce,pe-=ye,me-=Se,ce-=xe):(De-=ke,be-=Fe,we-=Ie,Be-=Ve,Je-=Ae),Ne-=t}}U=X,Z=P,H=E,O=z}while(-1!=i[N]);N++}}}},JSC3D.Viewer.prototype.renderSolidSphereMapped=function(e){var t=this.frameWidth,r=this.frameHeight,i=e.indexBuffer,s=e.transformedVertexBuffer,a=e.transformedVertexNormalBuffer,o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer,n=e.transformedFaceNormalZBuffer,h=this.colorBuffer,l=this.zBuffer,f=this.selectionBuffer,u=e.faceCount,d=(s.length/3,e.internalId),p=e.material?e.material:this.defaultMaterial,m=p.getPalette(),c=this.sphereMap,g=c.data,v=c.width,C=v-1,y=0==p.transparency,S=~~(255*p.transparency),x=255-S,D=e.isDoubleSided||this.isCullingDisabled;if(1!=p.transparency){(!a||a.length<e.vertexNormalBuffer.length)&&(e.transformedVertexNormalBuffer=new Array(e.vertexNormalBuffer.length),a=e.transformedVertexNormalBuffer),(!n||n.length<u)&&(e.transformedFaceNormalZBuffer=new Array(u),n=e.transformedFaceNormalZBuffer),JSC3D.Math3D.transformVectors(this.rotMatrix,e.vertexNormalBuffer,a),JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,n);for(var b=new Array(3),w=new Array(3),B=new Array(3),J=new Array(3),M=new Array(3),k=new Array(3),F=0,I=0;u>F;){var V=n[F++];if(D&&(V=V>0?V:-V),0>V){do;while(-1!=i[I++])}else{var A,N,L,Y,U,X;A=3*i[I],Y=3*o[I],I++,N=3*i[I],U=3*o[I],I++;do{L=3*i[I],X=3*o[I],I++,b[0]=~~(s[A]+.5),w[0]=~~(s[A+1]+.5),B[0]=s[A+2],b[1]=~~(s[N]+.5),w[1]=~~(s[N+1]+.5),B[1]=s[N+2],b[2]=~~(s[L]+.5),w[2]=~~(s[L+1]+.5),B[2]=s[L+2],J[0]=a[Y],M[0]=a[Y+1],k[0]=a[Y+2],J[1]=a[U],M[1]=a[U+1],k[1]=a[U+2],J[2]=a[X],M[2]=a[X+1],k[2]=a[X+2],D&&(k[0]<0&&(k[0]=-k[0]),k[1]<0&&(k[1]=-k[1]),k[2]<0&&(k[2]=-k[2]));var T=w[0]<w[1]?0:1;T=w[T]<w[2]?T:2;var Z=w[0]>w[1]?0:1;Z=w[Z]>w[2]?Z:2;var P=3-Z-T;if(T!=Z){var R=b[Z],H=B[Z],E=255*k[Z],W=(J[Z]/2+.5)*v&C,O=(.5-M[Z]/2)*v&C,z=w[Z]-w[T];z=0!=z?z:1;var q=(b[Z]-b[T])/z,j=(B[Z]-B[T])/z,G=255*(k[Z]-k[T])/z,K=(J[Z]-J[T])/2*v/z,_=(M[T]-M[Z])/2*v/z,Q=b[Z],$=B[Z],ee=255*k[Z],te=(J[Z]/2+.5)*v&C,re=(.5-M[Z]/2)*v&C,ie=w[Z]-w[P];ie=0!=ie?ie:1;var se=(b[Z]-b[P])/ie,ae=(B[Z]-B[P])/ie,oe=255*(k[Z]-k[P])/ie,ne=(J[Z]-J[P])/2*v/ie,he=(M[P]-M[Z])/2*v/ie,le=b[P],fe=B[P],ue=255*k[P],de=(J[P]/2+.5)*v&C,pe=(.5-M[P]/2)*v&C,me=w[P]-w[T];me=0!=me?me:1;for(var ce=(b[P]-b[T])/me,ge=(B[P]-B[T])/me,ve=255*(k[P]-k[T])/me,Ce=(J[P]-J[T])/2*v/me,ye=(M[T]-M[P])/2*v/me,Se=w[Z]*t,xe=w[Z];xe>w[T];xe--){if(xe>=0&&r>xe){var De,be,we,Be,Je,Me=~~R,ke=H,Fe=E,Ie=W,Ve=O;if(xe>w[P]?(De=~~Q,be=$,we=ee,Be=te,Je=re):(De=~~le,be=fe,we=ue,Be=de,Je=pe),Me>De){var Ae;Ae=Me,Me=De,De=Ae,Ae=ke,ke=be,be=Ae,Ae=Fe,Fe=we,we=Ae,Ae=Ie,Ie=Be,Be=Ae,Ae=Ve,Ve=Je,Je=Ae}var Ne=Me!=De?(be-ke)/(De-Me):1,Le=Me!=De?(we-Fe)/(De-Me):1,Ye=Me!=De?(Be-Ie)/(De-Me):1,Ue=Me!=De?(Je-Ve)/(De-Me):1;0>Me&&(ke-=Me*Ne,Fe-=Me*Le,Ie-=Ie*Ye,Ve-=Ve*Ue,Me=0),De>=t&&(De=t-1);var Xe=Se+Me;if(y)for(var Te=Me,Ze=ke,Pe=Fe,Re=Ie,He=Ve;De>=Te;Te++,Ze+=Ne,Pe+=Le,Re+=Ye,He+=Ue){if(Ze>l[Xe]){l[Xe]=Ze;var Ee=m[Pe>0?~~Pe:0],We=g[(He&C)*v+(Re&C)],Oe=((16711680&Ee)>>16)*((16711680&We)>>8),ze=((65280&Ee)>>8)*((65280&We)>>8),qe=(255&Ee)*(255&We)>>8;h[Xe]=4278190080|16711680&Oe|65280&ze|255&qe,f[Xe]=d}Xe++}else for(var Te=Me,Ze=ke,Pe=Fe,Re=Ie,He=Ve;De>Te;Te++,Ze+=Ne,Pe+=Le,Re+=Ye,He+=Ue){if(Ze>l[Xe]){var Ee=m[Pe>0?~~Pe:0],je=g[(He&C)*v+(Re&C)],Ge=h[Xe],Oe=((16711680&Ee)>>16)*((16711680&je)>>8),ze=((65280&Ee)>>8)*((65280&je)>>8),qe=(255&Ee)*(255&je)>>8,Ke=4278190080&(Ge|Ee);Oe=Oe*x+(16711680&Ge)*S>>8,ze=ze*x+(65280&Ge)*S>>8,qe=qe*x+(255&Ge)*S>>8,h[Xe]=Ke|16711680&Oe|65280&ze|255&qe,f[Xe]=d}Xe++}}R-=q,H-=j,E-=G,W-=K,O-=_,xe>w[P]?(Q-=se,$-=ae,ee-=oe,te-=ne,re-=he):(le-=ce,fe-=ge,ue-=ve,de-=Ce,pe-=ye),Se-=t}}N=L,U=X}while(-1!=i[I]);I++}}}},JSC3D.Viewer.prototype.params=null,JSC3D.Viewer.prototype.canvas=null,JSC3D.Viewer.prototype.ctx2d=null,JSC3D.Viewer.prototype.canvasData=null,JSC3D.Viewer.prototype.bkgColorBuffer=null,JSC3D.Viewer.prototype.colorBuffer=null,JSC3D.Viewer.prototype.zBuffer=null,JSC3D.Viewer.prototype.selectionBuffer=null,JSC3D.Viewer.prototype.frameWidth=0,JSC3D.Viewer.prototype.frameHeight=0,JSC3D.Viewer.prototype.scene=null,JSC3D.Viewer.prototype.defaultMaterial=null,JSC3D.Viewer.prototype.sphereMap=null,JSC3D.Viewer.prototype.isLoaded=!1,JSC3D.Viewer.prototype.isFailed=!1,JSC3D.Viewer.prototype.needUpdate=!1,JSC3D.Viewer.prototype.needRepaint=!1,JSC3D.Viewer.prototype.initRotX=0,JSC3D.Viewer.prototype.initRotY=0,JSC3D.Viewer.prototype.initRotZ=0,JSC3D.Viewer.prototype.zoomFactor=1,JSC3D.Viewer.prototype.panning=[0,0],JSC3D.Viewer.prototype.rotMatrix=null,JSC3D.Viewer.prototype.transformMatrix=null,JSC3D.Viewer.prototype.sceneUrl="",JSC3D.Viewer.prototype.modelColor=13280792,JSC3D.Viewer.prototype.bkgColor1=16777215,JSC3D.Viewer.prototype.bkgColor2=16777088,JSC3D.Viewer.prototype.renderMode="flat",JSC3D.Viewer.prototype.definition="standard",JSC3D.Viewer.prototype.isCullingDisabled=!1,JSC3D.Viewer.prototype.isMipMappingOn=!1,JSC3D.Viewer.prototype.creaseAngle=-180,JSC3D.Viewer.prototype.sphereMapUrl="",JSC3D.Viewer.prototype.showProgressBar=!0,JSC3D.Viewer.prototype.buttonStates=null,JSC3D.Viewer.prototype.keyStates=null,JSC3D.Viewer.prototype.mouseX=0,JSC3D.Viewer.prototype.mouseY=0,JSC3D.Viewer.prototype.onloadingstarted=null,JSC3D.Viewer.prototype.onloadingcomplete=null,JSC3D.Viewer.prototype.onloadingprogress=null,JSC3D.Viewer.prototype.onloadingaborted=null,JSC3D.Viewer.prototype.onloadingerror=null,JSC3D.Viewer.prototype.onmousedown=null,JSC3D.Viewer.prototype.onmouseup=null,JSC3D.Viewer.prototype.onmousemove=null,JSC3D.Viewer.prototype.onmousewheel=null,JSC3D.Viewer.prototype.onmouseclick=null,JSC3D.Viewer.prototype.beforeupdate=null,JSC3D.Viewer.prototype.afterupdate=null,JSC3D.Viewer.prototype.mouseUsage="default",JSC3D.Viewer.prototype.isDefaultInputHandlerEnabled=!1,JSC3D.PickInfo=function(){this.canvasX=0,this.canvasY=0,this.depth=-(1/0),this.mesh=null},JSC3D.Scene=function(e){this.name=e||"",this.srcUrl="",this.aabb=null,this.children=[],this.maxChildId=1},JSC3D.Scene.prototype.init=function(){if(!this.isEmpty()){for(var e=0;e<this.children.length;e++)this.children[e].init();this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB())}},JSC3D.Scene.prototype.isEmpty=function(){return 0==this.children.length},JSC3D.Scene.prototype.addChild=function(e){e.internalId=this.maxChildId++,this.children.push(e)},JSC3D.Scene.prototype.removeChild=function(e){var t=this.children.indexOf(e);t>=0&&this.children.splice(t,1)},JSC3D.Scene.prototype.getChildren=function(){return this.children.slice(0)},JSC3D.Scene.prototype.forEachChild=function(e){if("function"==typeof e)for(var t=0;t<this.children.length&&!e.call(null,this.children[t]);t++);},JSC3D.Scene.prototype.calcAABB=function(){this.aabb.minX=this.aabb.minY=this.aabb.minZ=1/0,this.aabb.maxX=this.aabb.maxY=this.aabb.maxZ=-(1/0);for(var e=0;e<this.children.length;e++){var t=this.children[e];if(!t.isTrivial()){var r=t.aabb.minX,i=t.aabb.minY,s=t.aabb.minZ,a=t.aabb.maxX,o=t.aabb.maxY,n=t.aabb.maxZ;this.aabb.minX>r&&(this.aabb.minX=r),this.aabb.minY>i&&(this.aabb.minY=i),this.aabb.minZ>s&&(this.aabb.minZ=s),this.aabb.maxX<a&&(this.aabb.maxX=a),this.aabb.maxY<o&&(this.aabb.maxY=o),this.aabb.maxZ<n&&(this.aabb.maxZ=n)}}},JSC3D.Scene.prototype.name="",JSC3D.Scene.prototype.srcUrl="",JSC3D.Scene.prototype.aabb=null,JSC3D.Scene.prototype.children=null,JSC3D.Scene.prototype.maxChildId=1,JSC3D.Mesh=function(e,t,r,i,s,a,o,n,h,l,f){this.name=e||"",this.metadata="",this.visible=void 0!=t?t:!0,this.renderMode=null,this.aabb=null,this.vertexBuffer=n||null,this.indexBuffer=h||null,this.vertexNormalBuffer=null,this.vertexNormalIndexBuffer=null,this.faceNormalBuffer=null,this.material=r||null,this.texture=i||null,this.faceCount=0,this.creaseAngle=s>=0?s:-180,this.isDoubleSided=a||!1,this.isEnvironmentCast=o||!1,this.internalId=0,this.texCoordBuffer=l||null,this.texCoordIndexBuffer=f||null,this.transformedVertexBuffer=null,this.transformedVertexNormalZBuffer=null,this.transformedFaceNormalZBuffer=null,this.transformedVertexNormalBuffer=null},JSC3D.Mesh.prototype.init=function(){this.isTrivial()||(0!=this.faceCount||(this.calcFaceCount(),0!=this.faceCount))&&(this.aabb||(this.aabb=new JSC3D.AABB,this.calcAABB()),this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals()),this.vertexNormalBuffer||(this.creaseAngle>=0?this.calcCreasedVertexNormals():(this.vertexNormalBuffer=new Array(this.vertexBuffer.length),this.calcVertexNormals())),this.normalizeFaceNormals(),this.transformedVertexBuffer=new Array(this.vertexBuffer.length))},JSC3D.Mesh.prototype.isTrivial=function(){return!this.vertexBuffer||this.vertexBuffer.length<3||!this.indexBuffer||this.indexBuffer.length<3},JSC3D.Mesh.prototype.setMaterial=function(e){this.material=e},JSC3D.Mesh.prototype.setTexture=function(e){this.texture=e},JSC3D.Mesh.prototype.hasTexture=function(){return null!=this.texture&&this.texture.hasData()&&null!=this.texCoordBuffer&&this.texCoordBuffer.length>=2&&(null==this.texCoordIndexBuffer||this.texCoordIndexBuffer.length>=3&&this.texCoordIndexBuffer.length>=this.indexBuffer.length)},JSC3D.Mesh.prototype.setRenderMode=function(e){this.renderMode=e},JSC3D.Mesh.prototype.calcFaceCount=function(){this.faceCount=0;var e=this.indexBuffer;-1!=e[e.length-1]&&e.push(-1);for(var t=0;t<e.length;t++)-1==e[t]&&this.faceCount++},JSC3D.Mesh.prototype.calcAABB=function(){for(var e=minY=minZ=1/0,t=maxY=maxZ=-(1/0),r=this.vertexBuffer,i=0;i<r.length;i+=3){var s=r[i],a=r[i+1],o=r[i+2];e>s&&(e=s),s>t&&(t=s),a<minY&&(minY=a),a>maxY&&(maxY=a),o<minZ&&(minZ=o),o>maxZ&&(maxZ=o)}this.aabb.minX=e,this.aabb.minY=minY,this.aabb.minZ=minZ,this.aabb.maxX=t,this.aabb.maxY=maxY,this.aabb.maxZ=maxZ},JSC3D.Mesh.prototype.calcFaceNormals=function(){for(var e=this.vertexBuffer,t=this.indexBuffer,r=this.faceNormalBuffer,i=0,s=0;i<t.length;){var a=3*t[i++],o=e[a],n=e[a+1],h=e[a+2];a=3*t[i++];var l=e[a],f=e[a+1],u=e[a+2];a=3*t[i++];var d=e[a],p=e[a+1],m=e[a+2],c=l-o,g=f-n,v=u-h,C=d-o,y=p-n,S=m-h,x=g*S-v*y,D=v*C-c*S,b=c*y-g*C;r[s++]=x,r[s++]=D,r[s++]=b;do;while(-1!=t[i++])}},JSC3D.Mesh.prototype.normalizeFaceNormals=function(){JSC3D.Math3D.normalizeVectors(this.faceNormalBuffer,this.faceNormalBuffer)},JSC3D.Mesh.prototype.calcVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals());for(var e=this.vertexBuffer,t=this.indexBuffer,r=this.faceNormalBuffer,i=this.vertexNormalBuffer,s=0;s<i.length;s++)i[s]=0;this.vertexNormalIndexBuffer=null;for(var s=(e.length/3,0),a=0,o=0;s<t.length;)if(o=t[s++],-1==o)a+=3;else{var n=3*o;i[n]+=r[a],i[n+1]+=r[a+1],i[n+2]+=r[a+2]}JSC3D.Math3D.normalizeVectors(i,i)},JSC3D.Mesh.prototype.calcCreasedVertexNormals=function(){this.faceNormalBuffer||(this.faceNormalBuffer=new Array(3*this.faceCount),this.calcFaceNormals());for(var e=this.indexBuffer,t=this.vertexBuffer.length/3,r=new Array(t),i=0,s=0,a=0,o=0;s<e.length;s++)if(o=e[s],o>=0){i+=3;var n=r[o];n?n.push(a):r[o]=[a]}else a++;var h=this.faceNormalBuffer,l=new Array(h.length);JSC3D.Math3D.normalizeVectors(h,l),(!this.vertexNormalBuffer||this.vertexNormalBuffer.length<i)&&(this.vertexNormalBuffer=new Array(i));for(var f=this.vertexNormalBuffer,s=0;s<f.length;s++)f[s]=0;this.vertexNormalIndexBuffer=[];for(var u=this.vertexNormalIndexBuffer,d=Math.cos(this.creaseAngle*Math.PI/180),s=0,o=0,p=0,m=0;s<e.length;s++)if(o=e[s],o>=0){var c=3*p,g=3*m;f[c]+=h[g],f[c+1]+=h[g+1],f[c+2]+=h[g+2];for(var v=l[g],C=l[g+1],y=l[g+2],n=r[o],S=0;S<n.length;S++){var x=n[S];if(m!=x){var D=3*x,b=l[D],w=l[D+1],B=l[D+2];v*b+C*w+y*B>d&&(f[c]+=h[D],f[c+1]+=h[D+1],f[c+2]+=h[D+2])}}u.push(p++)}else m++,u.push(-1);JSC3D.Math3D.normalizeVectors(f,f)},JSC3D.Mesh.prototype.checkValid=function(){},JSC3D.Mesh.prototype.name="",JSC3D.Mesh.prototype.metadata="",JSC3D.Mesh.prototype.visible=!1,JSC3D.Mesh.prototype.renderMode="flat",JSC3D.Mesh.prototype.aabb=null,JSC3D.Mesh.prototype.vertexBuffer=null,JSC3D.Mesh.prototype.indexBuffer=null,JSC3D.Mesh.prototype.vertexNormalBuffer=null,JSC3D.Mesh.prototype.vertexNormalIndexBuffer=null,JSC3D.Mesh.prototype.faceNormalBuffer=null,JSC3D.Mesh.prototype.texCoordBuffer=null,JSC3D.Mesh.prototype.texCoordIndexBuffer=null,JSC3D.Mesh.prototype.material=null,JSC3D.Mesh.prototype.texture=null,JSC3D.Mesh.prototype.faceCount=0,JSC3D.Mesh.prototype.creaseAngle=-180,JSC3D.Mesh.prototype.isDoubleSided=!1,JSC3D.Mesh.prototype.isEnvironmentCast=!1,JSC3D.Mesh.prototype.internalId=0,JSC3D.Mesh.prototype.transformedVertexBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalZBuffer=null,JSC3D.Mesh.prototype.transformedFaceNormalZBuffer=null,JSC3D.Mesh.prototype.transformedVertexNormalBuffer=null,JSC3D.Material=function(e,t,r,i,s){this.name=e||"",this.diffuseColor=r||8355711,this.ambientColor="number"==typeof t?t:(16711680&this.diffuseColor)>>3&16711680|(65280&this.diffuseColor)>>3&65280|(255&this.diffuseColor)>>3,this.transparency=i||0,this.simulateSpecular=s||!1,this.palette=null},JSC3D.Material.prototype.getPalette=function(){return this.palette||(this.palette=new Array(256),this.generatePalette()),this.palette},JSC3D.Material.prototype.generatePalette=function(){var e=(16711680&this.ambientColor)>>16,t=(65280&this.ambientColor)>>8,r=255&this.ambientColor,i=(16711680&this.diffuseColor)>>16,s=(65280&this.diffuseColor)>>8,a=255&this.diffuseColor;if(this.simulateSpecular){for(var o=0;204>o;){var n=Math.max(e,o*i/204),h=Math.max(t,o*s/204),l=Math.max(r,o*a/204);n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}for(;256>o;){var n=Math.max(e,i+(o-204)*(255-i)/82),h=Math.max(t,s+(o-204)*(255-s)/82),l=Math.max(r,a+(o-204)*(255-a)/82);n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}}else for(var o=0;256>o;){var n=Math.max(e,o*i/256),h=Math.max(t,o*s/256),l=Math.max(r,o*a/256);n>255&&(n=255),h>255&&(h=255),l>255&&(l=255),this.palette[o++]=n<<16|h<<8|l}},JSC3D.Material.prototype.name="",JSC3D.Material.prototype.ambientColor=0,JSC3D.Material.prototype.diffuseColor=8355711,JSC3D.Material.prototype.transparency=0,JSC3D.Material.prototype.simulateSpecular=!1,JSC3D.Material.prototype.palette=null,JSC3D.Texture=function(e,t){this.name=e||"",this.width=0,this.height=0,this.data=null,this.mipmaps=null,this.mipentries=null,this.hasTransparency=!1,this.srcUrl="",this.onready=t&&"function"==typeof t?t:null},JSC3D.Texture.prototype.createFromUrl=function(e,t){var r=this,i=new Image;i.onload=function(){r.data=null,r.mipmaps=null,r.mipentries=null,r.width=0,r.height=0,r.hasTransparency=!1,r.srcUrl="",r.createFromImage(this,t),JSC3D.console&&JSC3D.console.logInfo('Finished loading texture image file "'+this.src+'".')},i.onerror=function(){r.data=null,r.mipmaps=null,r.mipentries=null,r.width=0,r.height=0,r.hasTransparency=!1,r.srcUrl="",JSC3D.console&&JSC3D.console.logWarning('Failed to load texture image file "'+this.src+'". This texture will be discarded.')},i.crossOrigin="anonymous",i.src=encodeURI(e)},JSC3D.Texture.prototype.createFromImage=function(e,t){if(!(e.width<=0||e.height<=0)){var r=!1,i=JSC3D.Texture.cv;if(!i)try{i=document.createElement("canvas"),JSC3D.Texture.cv=i,r=!0}catch(s){return}var a=e.width>e.height?e.width:e.height;a=16>=a?16:32>=a?32:64>=a?64:128>=a?128:256>=a?256:512>=a?512:1024,(i.width!=a||i.height!=a)&&(i.width=i.height=a,r=!0);var o;try{var n=i.getContext("2d");r||n.clearRect(0,0,a,a),n.drawImage(e,0,0,a,a);var h=n.getImageData(0,0,a,a);o=h.data}catch(s){return}var l=o.length/4;this.data=new Array(l);for(var f,u=0,d=0;l>u;u++,d+=4)f=o[d+3],this.data[u]=f<<24|o[d]<<16|o[d+1]<<8|o[d+2],255>f&&(this.hasTransparency=!0);this.width=a,this.height=a,this.mipmaps=null,t&&this.generateMipmaps(),this.srcUrl=e.src,null!=this.onready&&"function"==typeof this.onready&&this.onready()}},JSC3D.Texture.prototype.hasData=function(){return null!=this.data},JSC3D.Texture.prototype.generateMipmaps=function(){if(!(this.width<=1||null==this.data||null!=this.mipmaps)){this.mipmaps=[this.data],this.mipentries=[1];for(var e=1+~~(.1+Math.log(this.width)*Math.LOG2E),t=this.width>>1,r=1;e>r;r++){for(var i=new Array(t*t),s=this.mipmaps[r-1],a=t<<1,o=0,n=0,h=0;t>h;h++){for(var l=0;t>l;l++){var f=s[o],u=s[o+1],d=s[o+a],p=s[o+a+1],m=((4278190080&f)>>>2)+((4278190080&u)>>>2)+((4278190080&d)>>>2)+((4278190080&p)>>>2)&4278190080,c=(16711680&f)+(16711680&u)+(16711680&d)+(16711680&p)>>2&16711680,g=(65280&f)+(65280&u)+(65280&d)+(65280&p)>>2&65280,v=(255&f)+(255&u)+(255&d)+(255&p)>>2&255;i[n]=m+c+g+v,o+=2,n++}o+=a}this.mipmaps.push(i),this.mipentries.push(Math.pow(4,r)),t>>=1}}},JSC3D.Texture.prototype.hasMipmap=function(){return null!=this.mipmaps},JSC3D.Texture.prototype.name="",JSC3D.Texture.prototype.data=null,JSC3D.Texture.prototype.mipmaps=null,JSC3D.Texture.prototype.mipentries=null,JSC3D.Texture.prototype.width=0,JSC3D.Texture.prototype.height=0,JSC3D.Texture.prototype.hasTransparency=!1,JSC3D.Texture.prototype.srcUrl="",JSC3D.Texture.prototype.onready=null,JSC3D.Texture.cv=null,JSC3D.AABB=function(){this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},JSC3D.AABB.prototype.center=function(e){return e?(e[0]=.5*(this.minX+this.maxX),e[1]=.5*(this.minY+this.maxY),e[2]=.5*(this.minZ+this.maxZ)):e=[.5*(this.minX+this.maxX),.5*(this.minY+this.maxY),.5*(this.minZ+this.maxZ)],e},JSC3D.AABB.prototype.lengthOfDiagonal=function(){var e=this.maxX-this.minX,t=this.maxY-this.minY,r=this.maxZ-this.minZ;return Math.sqrt(e*e+t*t+r*r)},JSC3D.Matrix3x4=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.identity=function(){this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=1,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=1,this.m23=0},JSC3D.Matrix3x4.prototype.scale=function(e,t,r){this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m20*=r,this.m21*=r,this.m22*=r,this.m23*=r},JSC3D.Matrix3x4.prototype.translate=function(e,t,r){this.m03+=e,this.m13+=t,this.m23+=r},JSC3D.Matrix3x4.prototype.rotateAboutXAxis=function(e){if(0!=e){e*=Math.PI/180;var t=Math.cos(e),r=Math.sin(e),i=t*this.m10-r*this.m20,s=t*this.m11-r*this.m21,a=t*this.m12-r*this.m22,o=t*this.m13-r*this.m23,n=t*this.m20+r*this.m10,h=t*this.m21+r*this.m11,l=t*this.m22+r*this.m12,f=t*this.m23+r*this.m13;this.m10=i,this.m11=s,this.m12=a,this.m13=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutYAxis=function(e){if(0!=e){e*=Math.PI/180;var t=Math.cos(e),r=Math.sin(e),i=t*this.m00+r*this.m20,s=t*this.m01+r*this.m21,a=t*this.m02+r*this.m22,o=t*this.m03+r*this.m23,n=t*this.m20-r*this.m00,h=t*this.m21-r*this.m01,l=t*this.m22-r*this.m02,f=t*this.m23-r*this.m03;this.m00=i,this.m01=s,this.m02=a,this.m03=o,this.m20=n,this.m21=h,this.m22=l,this.m23=f}},JSC3D.Matrix3x4.prototype.rotateAboutZAxis=function(e){if(0!=e){e*=Math.PI/180;var t=Math.cos(e),r=Math.sin(e),i=t*this.m10+r*this.m00,s=t*this.m11+r*this.m01,a=t*this.m12+r*this.m02,o=t*this.m13+r*this.m03,n=t*this.m00-r*this.m10,h=t*this.m01-r*this.m11,l=t*this.m02-r*this.m12,f=t*this.m03-r*this.m13;this.m00=n,this.m01=h,this.m02=l,this.m03=f,this.m10=i,this.m11=s,this.m12=a,this.m13=o}},JSC3D.Matrix3x4.prototype.multiply=function(e){var t=e.m00*this.m00+e.m01*this.m10+e.m02*this.m20,r=e.m00*this.m01+e.m01*this.m11+e.m02*this.m21,i=e.m00*this.m02+e.m01*this.m12+e.m02*this.m22,s=e.m00*this.m03+e.m01*this.m13+e.m02*this.m23+e.m03,a=e.m10*this.m00+e.m11*this.m10+e.m12*this.m20,o=e.m10*this.m01+e.m11*this.m11+e.m12*this.m21,n=e.m10*this.m02+e.m11*this.m12+e.m12*this.m22,h=e.m10*this.m03+e.m11*this.m13+e.m12*this.m23+e.m13,l=e.m20*this.m00+e.m21*this.m10+e.m22*this.m20,f=e.m20*this.m01+e.m21*this.m11+e.m22*this.m21,u=e.m20*this.m02+e.m21*this.m12+e.m22*this.m22,d=e.m20*this.m03+e.m21*this.m13+e.m22*this.m23+e.m23;this.m00=t,this.m01=r,this.m02=i,this.m03=s,this.m10=a,this.m11=o,this.m12=n,this.m13=h,this.m20=l,this.m21=f,this.m22=u,this.m23=d},JSC3D.Math3D={transformVectors:function(e,t,r){for(var i=0;i<t.length;i+=3){var s=t[i],a=t[i+1],o=t[i+2];r[i]=e.m00*s+e.m01*a+e.m02*o+e.m03,r[i+1]=e.m10*s+e.m11*a+e.m12*o+e.m13,r[i+2]=e.m20*s+e.m21*a+e.m22*o+e.m23}},transformVectorZs:function(e,t,r){for(var i=t.length/3,s=0,a=0;i>s;)r[s]=e.m20*t[a]+e.m21*t[a+1]+e.m22*t[a+2]+e.m23,s++,a+=3},normalizeVectors:function(e,t){for(var r=e.length,i=0;r>i;i+=3){var s=e[i],a=e[i+1],o=e[i+2],n=Math.sqrt(s*s+a*a+o*o);n>0&&(n=1/n,s*=n,a*=n,o*=n),t[i]=s,t[i+1]=a,t[i+2]=o}}},JSC3D.Util={ieXHRResponseBodyToString:function(e){for(var t=new VBArray(e).toArray(),r="",i=0;i<t.length-65536;i+=65536)r+=String.fromCharCode.apply(null,t.slice(i,i+65536));return r+String.fromCharCode.apply(null,t.slice(i));
}},JSC3D.PlatformInfo=function(){for(var e,t={browser:"other",version:"n/a",isTouchDevice:void 0!=document.createTouch,supportTypedArrays:void 0!=window.Uint32Array,supportWebGL:void 0!=window.WebGLRenderingContext},r=[["firefox",/Firefox[\/\s](\d+(?:\.\d+)*)/],["chrome",/Chrome[\/\s](\d+(?:\.\d+)*)/],["opera",/Opera[\/\s](\d+(?:\.\d+)*)/],["safari",/Safari[\/\s](\d+(?:\.\d+)*)/],["webkit",/AppleWebKit[\/\s](\d+(?:\.\d+)*)/],["ie",/MSIE[\/\s](\d+(?:\.\d+)*)/],["ie",/Trident\/\d+\.\d+;\s.*rv:(\d+(?:\.\d+)*)/]],i=0;i<r.length;i++)if(e=r[i][1].exec(window.navigator.userAgent)){t.browser=r[i][0],t.version=e[1];break}return t}(),JSC3D.BinaryStream=function(e,t){if(t)throw"JSC3D.BinaryStream constructor failed: Big endian is not supported yet!";this.data=e,this.offset=0},JSC3D.BinaryStream.prototype.size=function(){return this.data.length},JSC3D.BinaryStream.prototype.tell=function(){return this.offset},JSC3D.BinaryStream.prototype.seek=function(e){return 0>e||e>=this.data.length?!1:(this.offset=e,!0)},JSC3D.BinaryStream.prototype.reset=function(){this.offset=0},JSC3D.BinaryStream.prototype.skip=function(e){this.offset+e>this.data.length?this.offset=this.data.length:this.offset+=e},JSC3D.BinaryStream.prototype.available=function(){return this.data.length-this.offset},JSC3D.BinaryStream.prototype.eof=function(){return!(this.offset<this.data.length)},JSC3D.BinaryStream.prototype.readUInt8=function(){return this.decodeInt(1,!1)},JSC3D.BinaryStream.prototype.readInt8=function(){return this.decodeInt(1,!0)},JSC3D.BinaryStream.prototype.readUInt16=function(){return this.decodeInt(2,!1)},JSC3D.BinaryStream.prototype.readInt16=function(){return this.decodeInt(2,!0)},JSC3D.BinaryStream.prototype.readUInt32=function(){return this.decodeInt(4,!1)},JSC3D.BinaryStream.prototype.readInt32=function(){return this.decodeInt(4,!0)},JSC3D.BinaryStream.prototype.readFloat32=function(){return this.decodeFloat(4,23)},JSC3D.BinaryStream.prototype.readFloat64=function(){return this.decodeFloat(8,52)},JSC3D.BinaryStream.prototype.readBytes=function(e,t){var r=t;this.offset+t>this.data.length&&(r=this.data.length-this.offset);for(var i=0;r>i;i++)e[i]=255&this.data[this.offset++].charCodeAt(0);return r},JSC3D.BinaryStream.prototype.decodeInt=function(e,t){if(this.offset+e>this.data.length)return this.offset=this.data.length,NaN;for(var r=0,i=1,s=0;e>s;s++)r+=(255&this.data[this.offset++].charCodeAt(0))*i,i*=256;return t&&r&Math.pow(2,8*e-1)&&(r-=Math.pow(2,8*e)),r},JSC3D.BinaryStream.prototype.decodeFloat=function(e,t){if(this.offset+e>this.data.length)return this.offset=this.data.length,NaN;var r=t,i=8*e-r-1,s=(1<<i)-1,a=s>>1,o=e-1,n=-1,h=255&this.data[this.offset+o].charCodeAt(0);o+=n;var l=-7,f=h&(1<<-l)-1;for(h>>=-l,l+=i;l>0;)f=256*f+(255&this.data[this.offset+o].charCodeAt(0)),o+=n,l-=8;var u=f&(1<<-l)-1;for(f>>=-l,l+=r;l>0;)u=256*u+(255&this.data[this.offset+o].charCodeAt(0)),o+=n,l-=8;switch(this.offset+=e,f){case 0:f=1-a;break;case s:return u?NaN:(h?-1:1)*(1/0);default:u+=Math.pow(2,r),f-=a}return(h?-1:1)*u*Math.pow(2,f-r)},JSC3D.LoaderSelector={registerLoader:function(e,t){"function"==typeof t&&(JSC3D.LoaderSelector.loaderTable[e]=t)},getLoader:function(e){var t=JSC3D.LoaderSelector.loaderTable[e.toLowerCase()];if(!t)return null;var r;try{r=new t}catch(i){r=null}return r},loaderTable:{}},JSC3D.ObjLoader=function(e,t,r,i){this.onload=e&&"function"==typeof e?e:null,this.onerror=t&&"function"==typeof t?t:null,this.onprogress=r&&"function"==typeof r?r:null,this.onresource=i&&"function"==typeof i?i:null,this.requestCount=0,this.requests=[]},JSC3D.ObjLoader.prototype.loadFromUrl=function(e){var t="",r=e,i="",s=e.indexOf("?");s>=0&&(i=e.substring(s),r=e=e.substring(0,s));var a=e.lastIndexOf("/");-1==a&&(a=e.lastIndexOf("\\")),-1!=a&&(t=e.substring(0,a+1),r=e.substring(a+1)),this.requestCount=0,this.loadObjFile(t,r,i)},JSC3D.ObjLoader.prototype.abort=function(){for(var e=0;e<this.requests.length;e++)this.requests[e].abort();this.requests=[],this.requestCount=0},JSC3D.ObjLoader.prototype.loadObjFile=function(e,t,r){var i=e+t+r,s=this,a=new XMLHttpRequest;a.open("GET",encodeURI(i),!0),a.onreadystatechange=function(){if(4==this.readyState)if(200==this.status||0==this.status){if(s.onload){s.onprogress&&s.onprogress("Loading obj file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading obj file "'+i+'".');var t=new JSC3D.Scene;t.srcUrl=i;var r=s.parseObj(t,this.responseText);if(r.length>0)for(var a=0;a<r.length;a++)s.loadMtlFile(t,e,r[a]);s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(t)}}else s.requests.splice(s.requests.indexOf(this),1),s.requestCount--,JSC3D.console&&JSC3D.console.logError('Failed to load obj file "'+i+'".'),s.onerror&&s.onerror('Failed to load obj file "'+i+'".')},this.onprogress&&(this.onprogress("Loading obj file ...",0),a.onprogress=function(e){s.onprogress("Loading obj file ...",e.position/e.totalSize)}),this.requests.push(a),this.requestCount++,a.send()},JSC3D.ObjLoader.prototype.loadMtlFile=function(e,t,r){var i=t+r,s=this,a=new XMLHttpRequest;a.open("GET",encodeURI(i),!0),a.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){s.onprogress&&s.onprogress("Loading mtl file ...",1),JSC3D.console&&JSC3D.console.logInfo('Finished loading mtl file "'+i+'".');for(var a=s.parseMtl(this.responseText),o={},n=e.getChildren(),h=0;h<n.length;h++){var l=n[h];if(null!=l.mtl&&null!=l.mtllib&&l.mtllib==r){var f=a[l.mtl];null!=f&&(null!=f.material&&l.setMaterial(f.material),""!=f.textureFileName&&(o[f.textureFileName]?o[f.textureFileName].push(l):o[f.textureFileName]=[l]))}}for(var u in o)s.setupTexture(o[u],t+u)}else JSC3D.console&&JSC3D.console.logWarning('Failed to load mtl file "'+i+'". A default material will be applied.');s.requests.splice(s.requests.indexOf(this),1),0==--s.requestCount&&s.onload(e)}},this.onprogress&&(this.onprogress("Loading mtl file ...",0),a.onprogress=function(e){s.onprogress("Loading mtl file ...",e.position/e.totalSize)}),this.requests.push(a),this.requestCount++,a.send()},JSC3D.ObjLoader.prototype.parseObj=function(e,t){var r={},i=[],s="obj-",a=0,o=null,n="",h="",l=[],f=[],u=s+a++,d=new JSC3D.Mesh;d.name=u,d.indexBuffer=[],r.nomtl=d,o=d;for(var p=t.split(/[ \t]*\r?\n[ \t]*/),m=0;m<p.length;m++){var c=p[m],g=c.split(/[ \t]+/);if(g.length>0){var v=g[0];switch(v){case"v":if(g.length>3)for(var C=1;4>C;C++)l.push(parseFloat(g[C]));break;case"vn":break;case"vt":g.length>2&&(f.push(parseFloat(g[1])),f.push(1-parseFloat(g[2])));break;case"f":if(g.length>3){for(var C=1;C<g.length;C++){var y=g[C].split("/"),S=parseInt(y[0])-1;o.indexBuffer.push(S),y.length>1&&(""!=y[1]?(o.texCoordIndexBuffer||(o.texCoordIndexBuffer=[]),o.texCoordIndexBuffer.push(parseInt(y[1])-1)):(y.length<3||""==y[2])&&(o.texCoordIndexBuffer||(o.texCoordIndexBuffer=[]),o.texCoordIndexBuffer.push(S)))}o.indexBuffer.push(-1),o.texCoordIndexBuffer&&o.texCoordIndexBuffer.push(-1)}break;case"mtllib":g.length>1?(n=g[1],i.push(n)):n="";break;case"usemtl":if(g.length>1&&""!=g[1]&&""!=n){h=g[1];var x=n+"-"+h,D=r[x];D||(D=new JSC3D.Mesh,D.name=s+a++,D.indexBuffer=[],D.mtllib=n,D.mtl=h,r[x]=D),o=D}else h="",o=d;break;case"#":}}}var b=l.length>=3?new Array(l.length/3):null,w=f.length>=2?new Array(f.length/2):null;for(var B in r){var D=r[B];if(l.length>=3&&D.indexBuffer.length>0){for(var m=0;m<b.length;m++)b[m]=-1;D.vertexBuffer=[];for(var J=0,M=0,m=0;m<D.indexBuffer.length;m++)if(J=D.indexBuffer[m],-1!=J)if(-1==b[J]){var k=3*J;D.vertexBuffer.push(l[k]),D.vertexBuffer.push(l[k+1]),D.vertexBuffer.push(l[k+2]),D.indexBuffer[m]=M,b[J]=M,M++}else D.indexBuffer[m]=b[J]}if(f.length>=2&&null!=D.texCoordIndexBuffer&&D.texCoordIndexBuffer.length>0){for(var m=0;m<w.length;m++)w[m]=-1;D.texCoordBuffer=[];for(var F=0,I=0,m=0;m<D.texCoordIndexBuffer.length;m++)if(F=D.texCoordIndexBuffer[m],-1!=F)if(-1==w[F]){var V=2*F;D.texCoordBuffer.push(f[V]),D.texCoordBuffer.push(f[V+1]),D.texCoordIndexBuffer[m]=I,w[F]=I,I++}else D.texCoordIndexBuffer[m]=w[F]}D.isTrivial()||e.addChild(D)}return i},JSC3D.ObjLoader.prototype.parseMtl=function(e){for(var t={},r="",i=e.split(/[ \t]*\r?\n[ \t]*/),s=0;s<i.length;s++){var a=i[s],o=a.split(/[ \t]+/);if(o.length>0){var n=o[0];switch(n){case"newmtl":r=o[1];var h={};h.material=new JSC3D.Material,h.material.name=r,h.textureFileName="",t[r]=h;break;case"Ka":case"ka":break;case"Kd":case"kd":if(4==o.length&&!isNaN(o[1])){var l=255*parseFloat(o[1])&255,f=255*parseFloat(o[2])&255,u=255*parseFloat(o[3])&255,h=t[r];null!=h&&(h.material.diffuseColor=l<<16|f<<8|u)}break;case"Ks":case"ks":break;case"d":if(2==o.length&&!isNaN(o[1])){var d=parseFloat(o[1]),h=t[r];null!=h&&(h.material.transparency=1-d)}break;case"illum":break;case"map_Kd":case"map_kd":if(2==o.length){var p=o[1],h=t[r];null!=h&&(h.textureFileName=p)}break;case"#":}}}return t},JSC3D.ObjLoader.prototype.setupTexture=function(e,t){var r=this,i=new JSC3D.Texture;i.onready=function(){for(var t=0;t<e.length;t++)e[t].setTexture(this);r.onresource&&r.onresource(this)},i.createFromUrl(t)},JSC3D.ObjLoader.prototype.onload=null,JSC3D.ObjLoader.prototype.onerror=null,JSC3D.ObjLoader.prototype.onprogress=null,JSC3D.ObjLoader.prototype.onresource=null,JSC3D.ObjLoader.prototype.requestCount=0,JSC3D.LoaderSelector.registerLoader("obj",JSC3D.ObjLoader),JSC3D.StlLoader=function(e,t,r,i){this.onload=e&&"function"==typeof e?e:null,this.onerror=t&&"function"==typeof t?t:null,this.onprogress=r&&"function"==typeof r?r:null,this.onresource=i&&"function"==typeof i?i:null,this.decimalPrecision=3,this.request=null},JSC3D.StlLoader.prototype.loadFromUrl=function(e){var t=this,r="ie"==JSC3D.PlatformInfo.browser,i=!1,s=new XMLHttpRequest;s.open("GET",encodeURI(e),!0),i?s.responseType="blob":r?s.setRequestHeader("Accept-Charset","x-user-defined"):s.overrideMimeType("text/plain; charset=x-user-defined"),s.onreadystatechange=function(){if(4==this.readyState){if(200==this.status||0==this.status){if(JSC3D.console&&JSC3D.console.logInfo('Finished loading STL file "'+e+'".'),t.onload)if(t.onprogress&&t.onprogress("Loading STL file ...",1),i){var s=new FileReader;s.onload=function(r){var i=new JSC3D.Scene;i.srcUrl=e,t.parseStl(i,r.target.result),t.onload(i)},s.readAsText(this.response,"x-user-defined")}else if(r){var a=new JSC3D.Scene;a.srcUrl=e;try{t.parseStl(a,JSC3D.Util.ieXHRResponseBodyToString(this.responseBody))}catch(o){}t.onload(a)}else{var a=new JSC3D.Scene;a.srcUrl=e,t.parseStl(a,this.responseText),t.onload(a)}}else JSC3D.console&&JSC3D.console.logError('Failed to load STL file "'+e+'".'),t.onerror&&t.onerror('Failed to load STL file "'+e+'".');t.request=null}},this.onprogress&&(this.onprogress("Loading STL file ...",0),s.onprogress=function(e){t.onprogress("Loading STL file ...",e.position/e.totalSize)}),this.request=s,s.send()},JSC3D.StlLoader.prototype.abort=function(){this.request&&(this.request.abort(),this.request=null)},JSC3D.StlLoader.prototype.setDecimalPrecision=function(e){this.decimalPrecision=e},JSC3D.StlLoader.prototype.parseStl=function(e,t){var r=3,i=80,s=4,a=12,o=12,n=2,h=new JSC3D.Mesh;h.vertexBuffer=[],h.indexBuffer=[],h.faceNormalBuffer=[];var l=!1,f=new JSC3D.BinaryStream(t);f.skip(i+s);for(var u=0;256>u&&!f.eof();u++)if(f.readUInt8()>127){l=!0;break}if(JSC3D.console&&JSC3D.console.logInfo("This is recognised as "+(l?"a binary":"an ASCII")+" STL file."),l){f.reset(),f.skip(i);var d=f.readUInt32(),p=i+s+(a+o*r+n)*d;if(f.size()<p)return void(JSC3D.console&&JSC3D.console.logError("Failed to parse contents of the file. It seems not complete."));h.faceCount=d;for(var m={},u=0;d>u;u++){h.faceNormalBuffer.push(f.readFloat32()),h.faceNormalBuffer.push(f.readFloat32()),h.faceNormalBuffer.push(f.readFloat32());for(var c=0;r>c;c++){var g,v,C;g=f.readFloat32(),v=f.readFloat32(),C=f.readFloat32();var y=g.toFixed(this.decimalPrecision)+"-"+v.toFixed(this.decimalPrecision)+"-"+C.toFixed(this.decimalPrecision),S=m[y];void 0!=S?h.indexBuffer.push(S):(S=h.vertexBuffer.length/3,m[y]=S,h.vertexBuffer.push(g),h.vertexBuffer.push(v),h.vertexBuffer.push(C),h.indexBuffer.push(S))}h.indexBuffer.push(-1),f.skip(n)}}else{var x="facet\\s+normal\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+outer\\s+loop\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+endloop\\s+endfacet",D=new RegExp(x,"ig"),b=t.match(D);if(b){var d=b.length;h.faceCount=d;var m={};D.lastIndex=0,D.global=!1;for(var w=D.exec(t);null!=w;w=D.exec(t)){h.faceNormalBuffer.push(parseFloat(w[1]),parseFloat(w[2]),parseFloat(w[3]));for(var u=0;r>u;u++){var g=parseFloat(w[4+3*u]),v=parseFloat(w[5+3*u]),C=parseFloat(w[6+3*u]),y=g.toFixed(this.decimalPrecision)+"-"+v.toFixed(this.decimalPrecision)+"-"+C.toFixed(this.decimalPrecision),S=m[y];void 0===S&&(S=h.vertexBuffer.length/3,m[y]=S,h.vertexBuffer.push(g),h.vertexBuffer.push(v),h.vertexBuffer.push(C)),h.indexBuffer.push(S)}h.indexBuffer.push(-1)}}}h.isTrivial()||(Math.abs(h.faceNormalBuffer[0])<1e-6&&Math.abs(h.faceNormalBuffer[1])<1e-6&&Math.abs(h.faceNormalBuffer[2])<1e-6&&(h.faceNormalBuffer=null),e.addChild(h))},JSC3D.StlLoader.prototype.onload=null,JSC3D.StlLoader.prototype.onerror=null,JSC3D.StlLoader.prototype.onprogress=null,JSC3D.StlLoader.prototype.onresource=null,JSC3D.StlLoader.prototype.decimalPrecision=3,JSC3D.LoaderSelector.registerLoader("stl",JSC3D.StlLoader);
